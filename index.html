<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco Juvenil</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0px 10px -5px rgba(0, 0, 0, 0.04); /* Deeper shadow */
        }
        .btn-primary {
            background-image: linear-gradient(to right, #4F46E5, #6366F1); /* Gradient for primary buttons */
            color: white;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .input-field {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 1px solid #D1D5DB; /* Light gray border */
            width: 100%;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-field:focus {
            outline: none;
            border-color: #6366F1; /* Blue border on focus */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Light blue shadow on focus */
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            color: #6B7280; /* Gray text */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #6366F1;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tab-button:not(.active):hover {
            background-color: #F3F4F6; /* Light gray on hover for inactive tabs */
        }
        .hidden {
            display: none;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #E5E7EB; /* Light gray border */
        }
        th {
            background-color: #F9FAFB; /* Light header background */
            font-weight: 600;
            color: #4B5563; /* Darker gray text */
        }
        tr:hover {
            background-color: #F3F4F6; /* Light gray on row hover */
        }
        .btn-danger {
            background-color: #EF4444; /* Red */
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-danger:hover {
            background-color: #DC2626; /* Darker red */
            transform: translateY(-1px);
        }
        .btn-success {
            background-color: #22C55E; /* Green */
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-success:hover {
            background-color: #16A34A; /* Darker green */
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="container bg-gray-100">
        <div class="card p-8 md:p-10 w-full max-w-md mx-auto">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Banco Juvenil</h1>

            <div class="flex justify-center mb-6 bg-gray-50 rounded-xl p-1">
                <button id="loginTab" class="tab-button active flex-1">Iniciar Sesión</button>
                <button id="registerTab" class="tab-button flex-1">Registrarse</button>
            </div>

            <!-- Login Form -->
            <div id="loginSection">
                <p class="text-center text-gray-600 mb-6">¡Bienvenido de nuevo, campeón!</p>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="loginIdentifier" class="block text-gray-700 text-sm font-semibold mb-2">ID de Usuario (Email o ID único)</label>
                        <input type="text" id="loginIdentifier" class="input-field" placeholder="suid@bancojuvenil.com o su ID de Firebase" required>
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-gray-700 text-sm font-semibold mb-2">Contraseña</label>
                        <input type="password" id="loginPassword" class="input-field" placeholder="********" required>
                    </div>
                    <button type="submit" class="btn-primary w-full">Iniciar Sesión</button>
                </form>
            </div>

            <!-- Registration Form -->
            <div id="registerSection" class="hidden">
                <p class="text-center text-gray-600 mb-6">¡Únete a la familia del Banco Juvenil!</p>
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label for="registerName" class="block text-gray-700 text-sm font-semibold mb-2">Nombre</label>
                        <input type="text" id="registerName" class="input-field" placeholder="Juan" required>
                    </div>
                    <div>
                        <label for="registerSurname" class="block text-gray-700 text-sm font-semibold mb-2">Apellido</label>
                        <input type="text" id="registerSurname" class="input-field" placeholder="Pérez" required>
                    </div>
                    <div>
                        <label for="registerAge" class="block text-gray-700 text-sm font-semibold mb-2">Edad</label>
                        <input type="number" id="registerAge" class="input-field" placeholder="18" min="0" required>
                    </div>
                    <div>
                        <label for="registerPassword" class="block text-gray-700 text-sm font-semibold mb-2">Contraseña</label>
                        <input type="password" id="registerPassword" class="input-field" placeholder="********" required>
                    </div>
                    <button type="submit" class="btn-primary w-full">Registrarse</button>
                </form>
            </div>

            <!-- Message Box -->
            <div id="messageBox" class="mt-6 p-4 rounded-lg text-sm hidden" role="alert">
                <p id="messageText"></p>
                <button id="closeMessage" class="float-right text-gray-600 hover:text-gray-900 font-bold ml-4">&times;</button>
            </div>

            <!-- User Dashboard (Hidden initially) -->
            <div id="dashboardSection" class="hidden mt-8 text-center">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Bienvenido, <span id="dashboardUserName"></span>!</h2>
                <p class="text-lg text-gray-700 mb-4">Tu ID de Usuario: <span id="dashboardUserId" class="font-mono bg-gray-100 p-2 rounded-md text-sm"></span></p>
                <div class="mt-6 p-6 bg-blue-50 border border-blue-200 rounded-xl text-blue-800">
                    <h3 class="text-xl font-bold mb-2">Saldo Actual:</h3>
                    <p id="accountBalance" class="text-3xl font-extrabold">$0.00 USD</p>
                    <button id="toggleCurrency" class="mt-3 text-blue-600 hover:underline">Cambiar a DOP</button>
                </div>
                <div class="mt-8 space-y-4">
                    <button id="transferMoneyBtn" class="btn-primary w-full">Transferir Dinero</button>
                    <button id="depositMoneyBtn" class="btn-primary w-full">Depositar Dinero</button>
                    <button id="withdrawMoneyBtn" class="btn-primary w-full">Retirar Dinero</button>
                    <button id="adminPanelBtn" class="btn-primary w-full hidden bg-purple-600 hover:bg-purple-700">Panel de Administración</button>
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl shadow transition duration-200 w-full">Cerrar Sesión</button>
                </div>

                <!-- Transfer Money Modal -->
                <div id="transferModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
                    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Transferir Dinero</h3>
                        <form id="transferForm" class="space-y-4">
                            <div>
                                <label for="transferRecipientId" class="block text-gray-700 text-sm font-semibold mb-2">ID de Destinatario (Email o ID único)</label>
                                <input type="text" id="transferRecipientId" class="input-field" placeholder="emaildelotro@bancojuvenil.com o ID de Firebase" required>
                            </div>
                            <div>
                                <label for="transferAmount" class="block text-gray-700 text-sm font-semibold mb-2">Monto</label>
                                <input type="number" id="transferAmount" class="input-field" placeholder="100.00" min="0.01" step="0.01" required>
                            </div>
                            <div>
                                <label for="transferCurrency" class="block text-gray-700 text-sm font-semibold mb-2">Moneda</label>
                                <select id="transferCurrency" class="input-field">
                                    <option value="USD">Dólar (USD)</option>
                                    <option value="DOP">Peso Dominicano (DOP)</option>
                                </select>
                            </div>
                            <div class="flex justify-end space-x-4">
                                <button type="button" id="cancelTransfer" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-xl shadow transition duration-200">Cancelar</button>
                                <button type="submit" class="btn-primary">Confirmar Transferencia</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Deposit Money Modal -->
                <div id="depositModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
                    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Depositar Dinero</h3>
                        <form id="depositForm" class="space-y-4">
                            <div>
                                <label for="depositSerialNumber" class="block text-gray-700 text-sm font-semibold mb-2">Número de Serie Único</label>
                                <input type="text" id="depositSerialNumber" class="input-field" placeholder="Tu número de serie del depósito" required>
                            </div>
                            <div>
                                <label for="depositAmount" class="block text-gray-700 text-sm font-semibold mb-2">Monto (para referencia)</label>
                                <input type="number" id="depositAmount" class="input-field" placeholder="Ej: 500.00" min="0.01" step="0.01" required>
                            </div>
                            <div>
                                <label for="depositCurrency" class="block text-gray-700 text-sm font-semibold mb-2">Moneda</label>
                                <select id="depositCurrency" class="input-field">
                                    <option value="USD">Dólar (USD)</option>
                                    <option value="DOP">Peso Dominicano (DOP)</option>
                                </select>
                            </div>
                            <div class="flex justify-end space-x-4">
                                <button type="button" id="cancelDeposit" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-xl shadow transition duration-200">Cancelar</button>
                                <button type="submit" class="btn-primary">Solicitar Depósito</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Withdraw Money Modal -->
                <div id="withdrawModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
                    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Retirar Dinero</h3>
                        <form id="withdrawForm" class="space-y-4">
                            <div>
                                <label for="withdrawAmount" class="block text-gray-700 text-sm font-semibold mb-2">Monto</label>
                                <input type="number" id="withdrawAmount" class="input-field" placeholder="Ej: 200.00" min="0.01" step="0.01" required>
                            </div>
                            <div>
                                <label for="withdrawCurrency" class="block text-gray-700 text-sm font-semibold mb-2">Moneda</label>
                                <select id="withdrawCurrency" class="input-field">
                                    <option value="USD">Dólar (USD)</option>
                                    <option value="DOP">Peso Dominicano (DOP)</option>
                                </select>
                            </div>
                            <div class="flex justify-end space-x-4">
                                <button type="button" id="cancelWithdraw" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-xl shadow transition duration-200">Cancelar</button>
                                <button type="submit" class="btn-primary">Solicitar Retiro</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Transfer/Deposit/Withdrawal Status Message (for 2-minute transfers or pending deposits) -->
                <div id="transactionStatusMsg" class="mt-6 p-4 rounded-lg text-sm hidden bg-yellow-100 border border-yellow-200 text-yellow-800" role="status">
                    <p id="transactionStatusText"></p>
                </div>

            </div>

            <!-- Admin Dashboard (Hidden initially) -->
            <div id="adminSection" class="hidden mt-8 w-full max-w-lg mx-auto">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Panel de Administración</h2>

                <h3 class="text-xl font-bold text-gray-700 mb-3">Depósitos Pendientes</h3>
                <div class="table-container bg-white rounded-lg shadow mb-8">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th>Usuario ID</th>
                                <th>Serie</th>
                                <th>Monto</th>
                                <th>Moneda</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="pendingDepositsTableBody">
                            <!-- Deposits will be loaded here -->
                            <tr><td colspan="5" class="text-center text-gray-500 py-4">No hay depósitos pendientes.</td></tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="text-xl font-bold text-gray-700 mb-3">Retiros Pendientes</h3>
                <div class="table-container bg-white rounded-lg shadow">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th>Usuario ID</th>
                                <th>Monto</th>
                                <th>Moneda</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="pendingWithdrawalsTableBody">
                            <!-- Withdrawals will be loaded here -->
                            <tr><td colspan="4" class="text-center text-gray-500 py-4">No hay retiros pendientes.</td></tr>
                        </tbody>
                    </table>
                </div>

                <button id="backToDashboardBtn" class="btn-primary w-full mt-6">Volver al Panel de Usuario</button>
            </div>
        </div>
    </div>

    <!-- Rules Consent Modal (New) -->
    <div id="rulesConsentModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-4 text-gray-800 text-center">Reglas del Banco Juvenil</h3>
            <div id="briefRulesTextContainer" class="max-h-60 overflow-y-auto text-gray-700 text-sm mb-6 p-4 border rounded-lg bg-gray-50">
                <!-- Brief rules will be inserted here by JS -->
            </div>
            <div class="flex justify-end space-x-4">
                <button type="button" id="rejectRulesBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl shadow transition duration-200">Rechazar</button>
                <button type="button" id="acceptRulesBtn" class="btn-primary">Aceptar Reglas</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, serverTimestamp, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Your web app's Firebase configuration - provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyDfUxqjfr1UYo9KN1HwibNIXyAKSZCqYbw",
            authDomain: "banco-juvenil-12903.firebaseapp.com",
            projectId: "banco-juvenil-12903",
            storageBucket: "banco-juvenil-12903.firebaseapp.com",
            messagingSenderId: "421654654501",
            appId: "1:421654654501:web:c315e4d67c9289f6d619cc"
        };
        const appId = "banco-juvenil-12903"; // Using projectId as appId for Firestore path consistency

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null; // Stores the current authenticated user object
        let currentUserId = null; // Stores the UID of the current user (Firebase UID)
        let currentBalanceUSD = 0;
        let currentBalanceDOP = 0;
        let showCurrencyUSD = true; // Flag to toggle currency display

        // Exchange rate (example, in a real app this would come from an API)
        const USD_TO_DOP_RATE = 58.0; // Example rate

        // Admin email for prototype purposes - UPDATED TO MATCH USER'S ADMIN EMAIL
        const ADMIN_EMAIL = `admin.jhonnio@${appId}.com`; // This will be admin.jhonnio@banco-juvenil-12903.com

        // UI Elements
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const adminSection = document.getElementById('adminSection'); // Admin Section

        const loginForm = document.getElementById('loginForm');
        const loginIdentifierInput = document.getElementById('loginIdentifier'); // Renamed from loginEmail
        const registerForm = document.getElementById('registerForm');
        const registerNameInput = document.getElementById('registerName'); // Capture for temp data
        const registerSurnameInput = document.getElementById('registerSurname'); // Capture for temp data
        const registerAgeInput = document.getElementById('registerAge');     // Capture for temp data
        const registerPasswordInput = document.getElementById('registerPassword'); // Capture for temp data

        const logoutBtn = document.getElementById('logoutBtn');
        const dashboardUserName = document.getElementById('dashboardUserName');
        const dashboardUserId = document.getElementById('dashboardUserId');
        const accountBalance = document.getElementById('accountBalance');
        const toggleCurrencyBtn = document.getElementById('toggleCurrency');
        const adminPanelBtn = document.getElementById('adminPanelBtn'); // Admin Panel button
        const backToDashboardBtn = document.getElementById('backToDashboardBtn'); // Back button in admin panel
        const pendingDepositsTableBody = document.getElementById('pendingDepositsTableBody'); // Table for deposits
        const pendingWithdrawalsTableBody = document.getElementById('pendingWithdrawalsTableBody'); // Table for withdrawals

        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessage = document.getElementById('closeMessage');
        const transactionStatusMsg = document.getElementById('transactionStatusMsg');
        const transactionStatusText = document.getElementById('transactionStatusText');

        // Rules Consent Modal elements (New)
        const rulesConsentModal = document.getElementById('rulesConsentModal');
        const briefRulesTextContainer = document.getElementById('briefRulesTextContainer');
        const acceptRulesBtn = document.getElementById('acceptRulesBtn');
        const rejectRulesBtn = document.getElementById('rejectRulesBtn');

        // Store registration form data temporarily for rules consent
        let tempRegisterData = {};

        // Define brief rules text
        const briefRulesText = `
            <p class="mb-2"><strong>1. Seguridad de Cuenta:</strong> Tu contraseña es confidencial. Nunca la compartas. Eres responsable de la seguridad de tu ID de usuario y contraseña.</p>
            <p class="mb-2"><strong>2. Edad Mínima:</strong> Debes tener al menos 13 años para registrarte.</p>
            <p class="mb-2"><strong>3. Monedas:</strong> Manejamos USD y DOP. Las tasas de cambio aplican para conversiones.</p>
            <p class="mb-2"><strong>4. Depósitos:</strong> Todos los depósitos requieren aprobación del banco. No podrás hacer otro depósito si tienes uno pendiente.</p>
            <p class="mb-2"><strong>5. Retiros:</strong> Las solicitudes de retiro también requieren aprobación del banco. Se aplicará una tarifa del 4% a cada retiro.</p>
            <p><strong>6. Transferencias:</strong> Las transferencias tienen un tiempo de procesamiento de 2 minutos. Verifica bien al destinatario, no son reversibles.</p>
        `;

        // Modal elements
        const transferMoneyBtn = document.getElementById('transferMoneyBtn');
        const transferModal = document.getElementById('transferModal');
        const cancelTransfer = document.getElementById('cancelTransfer');
        const transferForm = document.getElementById('transferForm');

        const depositMoneyBtn = document.getElementById('depositMoneyBtn');
        const depositModal = document.getElementById('depositModal');
        const cancelDeposit = document.getElementById('cancelDeposit');
        const depositForm = document.getElementById('depositForm');

        const withdrawMoneyBtn = document.getElementById('withdrawMoneyBtn');
        const withdrawModal = document.getElementById('withdrawModal');
        const cancelWithdraw = document.getElementById('cancelWithdraw');
        const withdrawForm = document.getElementById('withdrawForm');

        // --- Utility Functions ---

        /**
         * Displays a message in the UI message box.
         * @param {string} msg The message to display.
         * @param {string} type The type of message (success, error, info).
         */
        function showMessage(msg, type = 'info') {
            messageText.textContent = msg;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');
            messageBox.classList.add('block');

            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else {
                messageBox.classList.add('bg-blue-100', 'text-blue-800');
            }
        }

        /**
         * Hides the UI message box.
         */
        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        /**
         * Displays a transaction status message.
         * @param {string} msg The message to display.
         */
        function showTransactionStatus(msg) {
            transactionStatusText.textContent = msg;
            transactionStatusMsg.classList.remove('hidden');
        }

        /**
         * Hides the transaction status message.
         */
        function hideTransactionStatus() {
            transactionStatusMsg.classList.add('hidden');
        }

        /**
         * Toggles visibility between sections.
         * @param {HTMLElement} showElement Element to show.
         * @param {HTMLElement} ...hideElements List of elements to hide.
         */
        function showSection(showElement, ...hideElements) {
            showElement.classList.remove('hidden');
            hideElements.forEach(el => el.classList.add('hidden'));
        }

        /**
         * Toggles the active state of login/register tabs.
         * @param {string} activeTabId 'login' or 'register'.
         */
        function toggleTabs(activeTabId) {
            if (activeTabId === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                showSection(loginSection, registerSection, dashboardSection, adminSection, rulesConsentModal); // Hide rules modal too
            } else {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                showSection(registerSection, loginSection, dashboardSection, adminSection, rulesConsentModal); // Hide rules modal too
            }
            hideMessage(); // Hide any previous messages when changing tabs
        }

        /**
         * Closes any open modal.
         */
        function closeModal(modalElement) {
            modalElement.classList.add('hidden');
        }

        // --- Firebase Authentication & Firestore Operations ---

        /**
         * Handles new user registration form submission (initiates rules consent).
         * @param {Event} e Form submission event.
         */
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage();
            const name = registerNameInput.value.trim();
            const surname = registerSurnameInput.value.trim();
            const age = parseInt(registerAgeInput.value);
            const password = registerPasswordInput.value;

            if (!name || !surname || !password || isNaN(age) || age <= 0) {
                showMessage('Por favor, completa todos los campos correctamente.', 'error');
                return;
            }

            // Store data temporarily for use after rules consent
            tempRegisterData = { name, surname, age, password };

            // Show rules consent modal
            briefRulesTextContainer.innerHTML = briefRulesText;
            rulesConsentModal.classList.remove('hidden');
        });

        /**
         * Performs the actual user registration after rules consent.
         * @param {string} name User's name.
         * @param {string} surname User's surname.
         * @param {number} age User's age.
         * @param {string} password User's password.
         */
        async function performRegistration(name, surname, age, password) {
            const generatedEmail = `${name.toLowerCase().replace(/\s/g, '')}.${surname.toLowerCase().replace(/\s/g, '')}@${appId}.com`;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, generatedEmail, password);
                const user = userCredential.user;
                const userId = user.uid;

                await setDoc(doc(db, 'artifacts', appId, 'users', userId), {
                    userId: userId,
                    name: name,
                    surname: surname,
                    age: age,
                    email: generatedEmail,
                    balanceUSD: 0,
                    balanceDOP: 0,
                    currencyPreference: 'USD',
                    hasPendingDeposit: false,
                    createdAt: serverTimestamp()
                });

                showMessage(`¡Registro exitoso, ${name}! Tu ID de usuario para iniciar sesión es: ${generatedEmail}. Por favor, anótalo.`, 'success');
                loginIdentifierInput.value = generatedEmail;
                loginPassword.value = password;
                toggleTabs('login');

            } catch (error) {
                console.error("Error during registration:", error);
                let errorMessage = 'Error al registrar. Por favor, inténtalo de nuevo.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = `Ya existe una cuenta con este nombre y apellido (ID de usuario: ${generatedEmail}). Prueba a iniciar sesión o usa otro nombre/apellido.`;
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'La contraseña debe tener al menos 6 caracteres.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Error en el formato del email generado. Contacta soporte.';
                } else if (error.code === 'auth/configuration-not-found') {
                    errorMessage = 'Error de configuración de autenticación. Asegúrate de que "Email/Password" esté habilitado en Firebase Auth.';
                }
                showMessage(errorMessage, 'error');
            } finally {
                tempRegisterData = {}; // Clear temporary data regardless of outcome
            }
        }


        /**
         * Handles user login, accepting email or Firebase UID.
         * @param {Event} e Form submission event.
         */
        async function handleLogin(e) {
            e.preventDefault();
            hideMessage();
            const identifier = loginIdentifierInput.value.trim(); // Can be email or UID
            const password = loginPassword.value;
            let emailToLogin = identifier;

            if (!identifier || !password) {
                showMessage('Por favor, ingresa tu ID de usuario y contraseña.', 'error');
                return;
            }

            try {
                // Check if the identifier looks like an email
                if (!identifier.includes('@')) {
                    // If not an email, assume it's a Firebase UID and try to find the associated email
                    const usersCollectionRef = collection(db, 'artifacts', appId, 'users');
                    const q = query(usersCollectionRef, where('userId', '==', identifier)); // Query by Firebase UID
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        showMessage('ID de usuario o contraseña incorrectos.', 'error');
                        return;
                    }
                    // Found user by UID, get their associated email
                    emailToLogin = querySnapshot.docs[0].data().email;
                    if (!emailToLogin) {
                        showMessage('No se pudo encontrar el email asociado a este ID de usuario.', 'error');
                        return;
                    }
                }

                // Attempt to sign in with the determined email and password
                await signInWithEmailAndPassword(auth, emailToLogin, password);
                // The onAuthStateChanged listener will handle UI update if login is successful

            } catch (error) {
                console.error("Error during login:", error);
                let errorMessage = 'Error al iniciar sesión. Verifica tu ID de usuario y contraseña.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = 'ID de usuario o contraseña incorrectos.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'El formato del ID de usuario (email) es inválido.';
                } else if (error.code === 'auth/configuration-not-found') {
                    errorMessage = 'Error de configuración de autenticación. Asegúrate de que "Email/Password" esté habilitado en Firebase Auth.';
                }
                showMessage(errorMessage, 'error');
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                // The onAuthStateChanged listener will handle UI update
            } catch (error) {
                console.error("Error during logout:", error);
                showMessage('Error al cerrar sesión. Por favor, inténtalo de nuevo.', 'error');
            }
        }

        /**
         * Updates the balance display in the UI.
         */
        function updateBalanceDisplay() {
            if (showCurrencyUSD) {
                accountBalance.textContent = `$${currentBalanceUSD.toFixed(2)} USD`;
                toggleCurrencyBtn.textContent = 'Cambiar a DOP';
            } else {
                accountBalance.textContent = `RD$${currentBalanceDOP.toFixed(2)} DOP`;
                toggleCurrencyBtn.textContent = 'Cambiar a USD';
            }
        }

        /**
         * Handles toggling currency display in the dashboard.
         */
        function toggleCurrencyDisplay() {
            showCurrencyUSD = !showCurrencyUSD;
            updateBalanceDisplay();
        }

        /**
         * Listens for authentication state changes to update the UI.
         */
        onAuthStateChanged(auth, async (user) => {
            hideMessage(); // Clear any messages
            hideTransactionStatus(); // Clear any transaction status messages

            if (user) {
                // User is signed in
                currentUser = user;
                currentUserId = user.uid;

                // Listen for real-time updates to the user's profile in Firestore
                // Path: artifacts/{appId}/users/{userId}
                const userProfileRef = doc(db, 'artifacts', appId, 'users', currentUserId);
                onSnapshot(userProfileRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        dashboardUserName.textContent = userData.name || 'Usuario';
                        dashboardUserId.textContent = userData.userId; // Display the actual Firebase UID

                        currentBalanceUSD = userData.balanceUSD || 0;
                        currentBalanceDOP = userData.balanceDOP || 0;
                        updateBalanceDisplay();

                        // Check for pending deposits and disable deposit button if necessary
                        if (userData.hasPendingDeposit) {
                            depositMoneyBtn.disabled = true;
                            depositMoneyBtn.textContent = 'Depósito Pendiente...';
                            showMessage('Tienes un depósito pendiente de aprobación. No puedes hacer otro depósito hasta que se confirme el actual.', 'info');
                        } else {
                            depositMoneyBtn.disabled = false;
                            depositMoneyBtn.textContent = 'Depositar Dinero';
                        }

                        // Show admin panel button if current user is admin
                        if (currentUser.email === ADMIN_EMAIL) {
                            adminPanelBtn.classList.remove('hidden');
                        } else {
                            adminPanelBtn.classList.add('hidden');
                        }

                    } else {
                        console.warn("User profile not found in Firestore for UID:", currentUserId);
                        // If user profile doesn't exist, sign out
                        handleLogout();
                    }
                }, (error) => {
                    console.error("Error listening to user profile:", error);
                    showMessage("Error al cargar los datos de tu perfil. Intenta recargar la página.", 'error');
                });

                // Display dashboard and hide login/register forms
                showSection(dashboardSection, loginSection, registerSection, adminSection, rulesConsentModal); // Ensure rules modal is hidden

            } else {
                // User is signed out
                currentUser = null;
                currentUserId = null;
                dashboardUserName.textContent = '';
                dashboardUserId.textContent = '';
                accountBalance.textContent = '$0.00 USD';
                toggleCurrencyBtn.textContent = 'Cambiar a DOP';
                showCurrencyUSD = true; // Reset currency display preference
                toggleTabs('login'); // Go back to login tab
            }
        });


        // --- Transfer Money Functionality ---

        /**
         * Shows the transfer money modal.
         */
        transferMoneyBtn.addEventListener('click', () => {
            transferModal.classList.remove('hidden');
        });

        /**
         * Closes the transfer money modal.
         */
        cancelTransfer.addEventListener('click', () => {
            closeModal(transferModal);
            transferForm.reset();
        });

        /**
         * Handles transfer form submission.
         * (This is a simplified implementation for time simulation.
         * Real security logic should be in a Cloud Function).
         */
        transferForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage();
            hideTransactionStatus();

            const recipientIdentifier = transferRecipientId.value.trim(); // User enters email or UID
            const amount = parseFloat(transferAmount.value);
            const currency = transferCurrency.value;

            if (amount <= 0 || isNaN(amount)) {
                showMessage('El monto a transferir debe ser un número positivo.', 'error');
                return;
            }

            let actualRecipientEmail = recipientIdentifier; // Assume it's an email by default
            let actualRecipientUid = null;

            // If identifier is not an email, assume it's a Firebase UID
            if (!recipientIdentifier.includes('@')) {
                const usersCollectionRef = collection(db, 'artifacts', appId, 'users');
                const q = query(usersCollectionRef, where('userId', '==', recipientIdentifier));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessage('Error: El ID de destinatario no existe.', 'error');
                    closeModal(transferModal);
                    return;
                }
                const recipientData = querySnapshot.docs[0].data();
                actualRecipientEmail = recipientData.email;
                actualRecipientUid = recipientData.userId;
            } else {
                // If it's an email, we need to find the UID
                const usersCollectionRef = collection(db, 'artifacts', appId, 'users');
                const q = query(usersCollectionRef, where('email', '==', recipientIdentifier));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    actualRecipientUid = querySnapshot.docs[0].data().userId;
                }
            }

            if (!actualRecipientUid) {
                showMessage('Error: No se pudo verificar el ID del destinatario.', 'error');
                closeModal(transferModal);
                return;
            }

            // Prevent self-transfer
            if (actualRecipientUid === currentUserId) {
                showMessage('No puedes transferir dinero a tu propia cuenta.', 'error');
                closeModal(transferModal);
                return;
            }

            // Check sender's balance
            let senderBalance = currency === 'USD' ? currentBalanceUSD : currentBalanceDOP;
            if (amount > senderBalance) {
                showMessage('Saldo insuficiente para realizar esta transferencia.', 'error');
                closeModal(transferModal);
                return;
            }

            showMessage(`Iniciando transferencia de ${amount.toFixed(2)} ${currency} a ${recipientIdentifier}... Por favor, espera 2 minutos.`, 'info');
            closeModal(transferModal); // Close the modal immediately
            showTransactionStatus(`Transferencia a ${recipientIdentifier} en proceso... (2 minutos restantes)`);
            transferForm.reset(); // Reset form fields

            // --- SIMULACIÓN DE 2 MINUTOS DE ESPERA ---
            let countdown = 120; // 2 minutes in seconds
            const interval = setInterval(() => {
                countdown--;
                if (countdown >= 0) {
                    showTransactionStatus(`Transferencia a ${recipientIdentifier} en proceso... (${Math.floor(countdown / 60)}:${(countdown % 60).toString().padStart(2, '0')} restantes)`);
                }

                if (countdown <= 0) {
                    clearInterval(interval);
                    showTransactionStatus('Transferencia completada. Actualizando saldos...');

                    // Perform the actual balance update after the delay
                    performTransfer(currentUserId, actualRecipientUid, amount, currency, recipientIdentifier);
                }
            }, 1000); // Update every second
        });

        /**
         * Executes the actual transfer logic after the delay.
         * In a real environment, this SHOULD BE A FIREBASE CLOUD FUNCTION for security.
         * @param {string} senderUid Firebase UID of the sender.
         * @param {string} actualRecipientUid Firebase UID of the recipient.
         * @param {number} amount Amount to transfer.
         * @param {string} currency Currency of the transfer (USD/DOP).
         * @param {string} recipientIdentifier The ID (email or UID) the user entered for the recipient.
         */
        async function performTransfer(senderUid, actualRecipientUid, amount, currency, recipientIdentifier) {
            try {
                const senderProfileRef = doc(db, 'artifacts', appId, 'users', senderUid);
                const recipientProfileRef = doc(db, 'artifacts', appId, 'users', actualRecipientUid);

                // Get current balances for transaction (ideally this entire block would be atomic in Cloud Function)
                const senderSnap = await getDoc(senderProfileRef);
                const recipientSnap = await getDoc(recipientProfileRef);

                if (!senderSnap.exists() || !recipientSnap.exists()) {
                    showMessage('Error: No se encontraron los perfiles de remitente o destinatario para completar la transferencia.', 'error');
                    hideTransactionStatus();
                    return;
                }

                const senderData = senderSnap.data();
                const recipientData = recipientSnap.data();

                let senderCurrentBalanceUSD = senderData.balanceUSD || 0;
                let senderCurrentBalanceDOP = senderData.balanceDOP || 0;
                let recipientCurrentBalanceUSD = recipientData.balanceUSD || 0;
                let recipientCurrentBalanceDOP = recipientData.balanceDOP || 0;

                // Convert amount to USD for internal calculation if currency is DOP
                let amountInUSD = amount;
                if (currency === 'DOP') {
                    amountInUSD = amount / USD_TO_DOP_RATE;
                }

                // Update sender's balance
                senderCurrentBalanceUSD -= amountInUSD;
                senderCurrentBalanceDOP = senderCurrentBalanceUSD * USD_TO_DOP_RATE;

                // Update recipient's balance
                recipientCurrentBalanceUSD += amountInUSD;
                recipientCurrentBalanceDOP = recipientCurrentBalanceUSD * USD_TO_DOP_RATE;

                // Perform updates in Firestore
                await updateDoc(senderProfileRef, {
                    balanceUSD: senderCurrentBalanceUSD,
                    balanceDOP: senderCurrentBalanceDOP
                });

                await updateDoc(recipientProfileRef, {
                    balanceUSD: recipientCurrentBalanceUSD,
                    balanceDOP: recipientCurrentBalanceDOP
                });

                // Record the transaction in a public collection
                // Path: artifacts/{appId}/public/data/transactions
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                    senderId: senderUid,
                    recipientId: actualRecipientUid,
                    amount: amount,
                    currency: currency,
                    timestamp: serverTimestamp(),
                    type: 'transfer',
                    status: 'completed'
                });

                showMessage(`Transferencia de ${amount.toFixed(2)} ${currency} a ${recipientIdentifier} completada exitosamente.`, 'success');
                hideTransactionStatus();
                // Balances will be updated automatically by the onSnapshot listener

            } catch (error) {
                console.error("Error al completar la transferencia:", error);
                showMessage('Error al procesar la transferencia. Por favor, inténtalo de nuevo.', 'error');
                hideTransactionStatus();
            }
        }


        // --- Deposit Money Functionality ---

        /**
         * Shows the deposit money modal.
         */
        depositMoneyBtn.addEventListener('click', () => {
            depositModal.classList.remove('hidden');
        });

        /**
         * Closes the deposit money modal.
         */
        cancelDeposit.addEventListener('click', () => {
            closeModal(depositModal);
            depositForm.reset();
        });

        /**
         * Handles deposit form submission.
         * (Admin approval is a key feature here and should be handled by Cloud Functions).
         */
        depositForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage();
            hideTransactionStatus();

            const serialNumber = depositSerialNumber.value.trim();
            const amount = parseFloat(depositAmount.value);
            const currency = depositCurrency.value;

            if (amount <= 0 || isNaN(amount)) {
                showMessage('El monto debe ser un número positivo.', 'error');
                return;
            }
            if (!serialNumber) {
                showMessage('Por favor, ingresa un número de serie único para tu depósito.', 'error');
                return;
            }

            try {
                // Check if user already has a pending deposit
                const userDocRef = doc(db, 'artifacts', appId, 'users', currentUserId);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists() && userDocSnap.data().hasPendingDeposit) {
                     showMessage('Ya tienes un depósito pendiente de aprobación. No puedes solicitar otro.', 'error');
                     closeModal(depositModal);
                     depositForm.reset();
                     return;
                }

                // Add deposit request to a public 'pending_deposits' collection
                // Path: artifacts/{appId}/public/data/pending_deposits
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pending_deposits'), {
                    userId: currentUserId, // Firebase UID of the user who made the deposit request
                    serialNumber: serialNumber,
                    amount: amount,
                    currency: currency,
                    timestamp: serverTimestamp(),
                    status: 'pending' // Status for admin approval
                });

                // Update user's profile to mark that they have a pending deposit
                await updateDoc(userDocRef, {
                    hasPendingDeposit: true
                });

                showMessage(`Solicitud de depósito de ${amount.toFixed(2)} ${currency} con número de serie ${serialNumber} enviada. Esperando aprobación del banco.`, 'success');
                closeModal(depositModal);
                depositForm.reset();

            } catch (error) {
                console.error("Error al solicitar depósito:", error);
                showMessage('Error al procesar la solicitud de depósito. Inténtalo de nuevo.', 'error');
            }
        });

        // --- Withdraw Money Functionality ---

        /**
         * Shows the withdraw money modal.
         */
        withdrawMoneyBtn.addEventListener('click', () => {
            withdrawModal.classList.remove('hidden');
        });

        /**
         * Closes the withdraw money modal.
         */
        cancelWithdraw.addEventListener('click', () => {
            closeModal(withdrawModal);
            withdrawForm.reset();
        });

        /**
         * Handles withdrawal form submission.
         * (Admin approval is a key feature here and should be handled by Cloud Functions).
         */
        withdrawForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage();
            hideTransactionStatus();

            const amount = parseFloat(withdrawAmount.value);
            const currency = withdrawCurrency.value;

            if (amount <= 0 || isNaN(amount)) {
                showMessage('El monto a retirar debe ser un número positivo.', 'error');
                return;
            }

            // Check user's balance for requested amount (fee is calculated later)
            let userBalance = currency === 'USD' ? currentBalanceUSD : currentBalanceDOP;
            // The user must have enough to cover the withdrawal amount PLUS the fee
            let amountWithPotentialFeeInUSD = amount;
            if (currency === 'DOP') {
                amountWithPotentialFeeInUSD = amount / USD_TO_DOP_RATE;
            }
            const estimatedFeeInUSD = amountWithPotentialFeeInUSD * 0.04; // Calculate based on requested amount
            const totalRequiredForWithdrawalInUSD = amountWithPotentialFeeInUSD + estimatedFeeInUSD;

            if (currentBalanceUSD < totalRequiredForWithdrawalInUSD) {
                showMessage(`Saldo insuficiente para cubrir el retiro de ${amount.toFixed(2)} ${currency} y la tarifa del 4%. Necesitas $${totalRequiredForWithdrawalInUSD.toFixed(2)} USD.`, 'error');
                return;
            }

            try {
                // Add withdrawal request to a public 'pending_withdrawals' collection
                // Path: artifacts/{appId}/public/data/pending_withdrawals
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pending_withdrawals'), {
                    userId: currentUserId,
                    amount: amount,
                    currency: currency,
                    timestamp: serverTimestamp(),
                    status: 'pending' // Status for admin approval
                });

                showMessage(`Solicitud de retiro de ${amount.toFixed(2)} ${currency} enviada. Esperando aprobación del banco. Se aplicará una tarifa del 4% al confirmar.`, 'success');
                closeModal(withdrawModal);
                withdrawForm.reset();

            } catch (error) {
                console.error("Error al solicitar retiro:", error);
                showMessage('Error al procesar la solicitud de retiro. Inténtalo de nuevo.', 'error');
            }
        });

        // --- Admin Panel Functionality ---

        /**
         * Loads and displays pending deposits in the admin panel table.
         */
        function loadPendingDeposits() {
            // Path: artifacts/{appId}/public/data/pending_deposits
            const depositsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'pending_deposits');
            const q = query(depositsCollectionRef, where('status', '==', 'pending'));

            onSnapshot(q, async (snapshot) => {
                pendingDepositsTableBody.innerHTML = ''; // Clear current table
                if (snapshot.empty) {
                    pendingDepositsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">No hay depósitos pendientes.</td></tr>';
                    return;
                }

                for (const docEntry of snapshot.docs) { // Use for...of with await
                    const deposit = docEntry.data();
                    const depositId = docEntry.id; // Document ID for the pending deposit

                    // Fetch user's name for display in the admin panel
                    const userProfileRef = doc(db, 'artifacts', appId, 'users', deposit.userId);
                    const userDocSnap = await getDoc(userProfileRef);
                    // Display name and truncated Firebase UID
                    const userNameDisplay = userDocSnap.exists() ? `${userDocSnap.data().name} ${userDocSnap.data().surname}` : `ID: ${deposit.userId.substring(0, 5)}...`;


                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${userNameDisplay}</td>
                        <td>${deposit.serialNumber}</td>
                        <td>${deposit.amount.toFixed(2)} ${deposit.currency}</td>
                        <td>${new Date(deposit.timestamp.seconds * 1000).toLocaleString()}</td>
                        <td>
                            <button class="btn-success confirm-deposit-btn" data-deposit-id="${depositId}" data-user-id="${deposit.userId}" data-amount="${deposit.amount}" data-currency="${deposit.currency}">Confirmar</button>
                            <button class="btn-danger reject-deposit-btn" data-deposit-id="${depositId}" data-user-id="${deposit.userId}">Rechazar</button>
                        </td>
                    `;
                    pendingDepositsTableBody.appendChild(row);
                }

                // Add event listeners to the new buttons
                document.querySelectorAll('.confirm-deposit-btn').forEach(button => {
                    button.onclick = async (event) => {
                        const depositId = event.target.dataset.depositId;
                        const userId = event.target.dataset.userId;
                        const amount = parseFloat(event.target.dataset.amount);
                        const currency = event.target.dataset.currency;
                        await confirmDeposit(depositId, userId, amount, currency);
                    };
                });
                document.querySelectorAll('.reject-deposit-btn').forEach(button => {
                    button.onclick = async (event) => {
                        const depositId = event.target.dataset.depositId;
                        const userId = event.target.dataset.userId; // Pass userId for resetting hasPendingDeposit
                        await rejectDeposit(depositId, userId);
                    };
                });

            }, (error) => {
                console.error("Error loading pending deposits:", error);
                pendingDepositsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-red-500 py-4">Error al cargar depósitos.</td></tr>`;
            });
        }

        /**
         * Confirms a pending deposit, updating the user's balance.
         * @param {string} depositId The document ID of the pending deposit.
         * @param {string} userId The Firebase UID of the user who made the deposit.
         * @param {number} amount The deposit amount.
         * @param {string} currency The deposit currency.
         */
        async function confirmDeposit(depositId, userId, amount, currency) {
            try {
                // Get references to the user's profile and the pending deposit document
                const userProfileRef = doc(db, 'artifacts', appId, 'users', userId);
                const depositDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'pending_deposits', depositId);

                // Get user's current data
                const userDocSnap = await getDoc(userProfileRef);
                if (!userDocSnap.exists()) {
                    showMessage('Error: Usuario no encontrado para el depósito.', 'error');
                    return;
                }
                const userData = userDocSnap.data();

                let newBalanceUSD = userData.balanceUSD || 0;
                let newBalanceDOP = userData.balanceDOP || 0;

                // Convert deposit amount to USD for internal calculation
                let depositAmountInUSD = amount;
                if (currency === 'DOP') {
                    depositAmountInUSD = amount / USD_TO_DOP_RATE;
                }

                newBalanceUSD += depositAmountInUSD;
                newBalanceDOP = newBalanceUSD * USD_TO_DOP_RATE; // Update DOP based on new USD balance

                // Update user's balance and reset hasPendingDeposit flag
                await updateDoc(userProfileRef, {
                    balanceUSD: newBalanceUSD,
                    balanceDOP: newBalanceDOP,
                    hasPendingDeposit: false // Allow user to make new deposits
                });

                // Update the deposit status to 'completed'
                await updateDoc(depositDocRef, {
                    status: 'completed',
                    confirmedAt: serverTimestamp()
                });

                showMessage(`Depósito #${depositId} de ${amount.toFixed(2)} ${currency} para ${userData.name} confirmado exitosamente.`, 'success');
                // The `onSnapshot` for pending deposits will automatically update the table

            } catch (error) {
                console.error("Error confirming deposit:", error);
                showMessage('Error al confirmar el depósito. Por favor, inténtalo de nuevo.', 'error');
            }
        }

        /**
         * Rejects a pending deposit, deleting it from the list and resetting the user's hasPendingDeposit flag.
         * @param {string} depositId The document ID of the pending deposit.
         * @param {string} userId The Firebase UID of the user who made the deposit.
         */
        async function rejectDeposit(depositId, userId) {
            try {
                const depositDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'pending_deposits', depositId);
                const userProfileRef = doc(db, 'artifacts', appId, 'users', userId);

                // Reset hasPendingDeposit flag for the user
                await updateDoc(userProfileRef, {
                    hasPendingDeposit: false
                });

                // Delete the pending deposit document (or change status to 'rejected')
                await deleteDoc(depositDocRef);
                showMessage(`Depósito #${depositId} rechazado exitosamente.`, 'info');
            } catch (error) {
                console.error("Error rejecting deposit:", error);
                showMessage('Error al rechazar el depósito. Por favor, inténtalo de nuevo.', 'error');
            }
        }

        /**
         * Loads and displays pending withdrawals in the admin panel table.
         */
        function loadPendingWithdrawals() {
            // Path: artifacts/{appId}/public/data/pending_withdrawals
            const withdrawalsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'pending_withdrawals');
            const q = query(withdrawalsCollectionRef, where('status', '==', 'pending'));

            onSnapshot(q, async (snapshot) => {
                pendingWithdrawalsTableBody.innerHTML = ''; // Clear current table
                if (snapshot.empty) {
                    pendingWithdrawalsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-4">No hay retiros pendientes.</td></tr>';
                    return;
                }

                for (const docEntry of snapshot.docs) {
                    const withdrawal = docEntry.data();
                    const withdrawalId = docEntry.id;

                    const userProfileRef = doc(db, 'artifacts', appId, 'users', withdrawal.userId);
                    const userDocSnap = await getDoc(userProfileRef);
                    const userNameDisplay = userDocSnap.exists() ? `${userDocSnap.data().name} ${userDocSnap.data().surname}` : `ID: ${withdrawal.userId.substring(0, 5)}...`;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${userNameDisplay}</td>
                        <td>${withdrawal.amount.toFixed(2)} ${withdrawal.currency}</td>
                        <td>${new Date(withdrawal.timestamp.seconds * 1000).toLocaleString()}</td>
                        <td>
                            <button class="btn-success confirm-withdrawal-btn" data-withdrawal-id="${withdrawalId}" data-user-id="${withdrawal.userId}" data-amount="${withdrawal.amount}" data-currency="${withdrawal.currency}">Confirmar</button>
                            <button class="btn-danger reject-withdrawal-btn" data-withdrawal-id="${withdrawalId}" data-user-id="${withdrawal.userId}">Rechazar</button>
                        </td>
                    `;
                    pendingWithdrawalsTableBody.appendChild(row);
                }

                document.querySelectorAll('.confirm-withdrawal-btn').forEach(button => {
                    button.onclick = async (event) => {
                        const withdrawalId = event.target.dataset.withdrawalId;
                        const userId = event.target.dataset.userId;
                        const amount = parseFloat(event.target.dataset.amount);
                        const currency = event.target.dataset.currency;
                        await confirmWithdrawal(withdrawalId, userId, amount, currency);
                    };
                });
                document.querySelectorAll('.reject-withdrawal-btn').forEach(button => {
                    button.onclick = async (event) => {
                        const withdrawalId = event.target.dataset.withdrawalId;
                        const userId = event.target.dataset.userId;
                        await rejectWithdrawal(withdrawalId, userId);
                    };
                });
            }, (error) => {
                console.error("Error loading pending withdrawals:", error);
                pendingWithdrawalsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 py-4">Error al cargar retiros.</td></tr>`;
            });
        }

        /**
         * Confirms a pending withdrawal, updating the user's balance and transferring fee to admin.
         * @param {string} withdrawalId The document ID of the pending withdrawal.
         * @param {string} userId The Firebase UID of the user who made the withdrawal.
         * @param {number} amount The withdrawal amount.
         * @param {string} currency The withdrawal currency.
         */
        async function confirmWithdrawal(withdrawalId, userId, amount, currency) {
            try {
                const userProfileRef = doc(db, 'artifacts', appId, 'users', userId);
                const withdrawalDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'pending_withdrawals', withdrawalId);

                const userDocSnap = await getDoc(userProfileRef);
                if (!userDocSnap.exists()) {
                    showMessage('Error: Usuario no encontrado para el retiro.', 'error');
                    return;
                }
                const userData = userDocSnap.data();

                let newBalanceUSD = userData.balanceUSD || 0;
                let newBalanceDOP = userData.balanceDOP || 0;

                let withdrawalAmountInUSD = amount;
                if (currency === 'DOP') {
                    withdrawalAmountInUSD = amount / USD_TO_DOP_RATE;
                }

                // Calculate 4% fee
                const feePercentage = 0.04;
                const feeInUSD = withdrawalAmountInUSD * feePercentage;
                const totalDeductionFromUserInUSD = withdrawalAmountInUSD; // User is charged the requested amount + fee. The fee is then added to admin.

                // Ensure user has sufficient balance before confirming including the fee
                if (newBalanceUSD < totalDeductionFromUserInUSD) { // Check only for requested amount, because fee is taken from their balance directly in this step
                    showMessage(`Error: Saldo insuficiente ($${newBalanceUSD.toFixed(2)} USD) para confirmar este retiro de ${amount.toFixed(2)} ${currency}.`, 'error');
                    return;
                }

                // Deduct the full requested amount from user (including the portion that is fee)
                newBalanceUSD -= totalDeductionFromUserInUSD;
                newBalanceDOP = newBalanceUSD * USD_TO_DOP_RATE;

                await updateDoc(userProfileRef, {
                    balanceUSD: newBalanceUSD,
                    balanceDOP: newBalanceDOP
                });

                // Add the fee to the admin's account
                const adminUsersCollectionRef = collection(db, 'artifacts', appId, 'users');
                const adminQuery = query(adminUsersCollectionRef, where('email', '==', ADMIN_EMAIL));
                const adminSnapshot = await getDocs(adminQuery);

                if (!adminSnapshot.empty) {
                    const adminDoc = adminSnapshot.docs[0];
                    const adminId = adminDoc.id;
                    const adminProfileRef = doc(db, 'artifacts', appId, 'users', adminId);
                    const adminData = adminDoc.data();

                    let adminNewBalanceUSD = (adminData.balanceUSD || 0) + feeInUSD;
                    let adminNewBalanceDOP = adminNewBalanceUSD * USD_TO_DOP_RATE;

                    await updateDoc(adminProfileRef, {
                        balanceUSD: adminNewBalanceUSD,
                        balanceDOP: adminNewBalanceDOP
                    });

                    // Record the fee transaction for the admin (optional but good for audit)
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                        payerId: userId, // User who paid the fee
                        receiverId: adminId, // Admin who received the fee
                        amount: feeInUSD,
                        currency: 'USD',
                        timestamp: serverTimestamp(),
                        type: 'withdrawal_fee',
                        status: 'completed',
                        originalWithdrawalId: withdrawalId // Link to original withdrawal
                    });

                } else {
                    console.warn("Admin account not found for fee collection.");
                    showMessage('Advertencia: Cuenta de administrador no encontrada para cobrar la tarifa de retiro. Contacta soporte.', 'warning');
                }

                // Update the withdrawal status to 'completed' and record fee details
                await updateDoc(withdrawalDocRef, {
                    status: 'completed',
                    confirmedAt: serverTimestamp(),
                    feeAmount: feeInUSD,
                    feeCurrency: 'USD'
                });

                showMessage(`Retiro #${withdrawalId} de ${amount.toFixed(2)} ${currency} para ${userData.name} confirmado exitosamente. Se cobró una tarifa del 4% ($${feeInUSD.toFixed(2)} USD).`, 'success');

            } catch (error) {
                console.error("Error confirming withdrawal:", error);
                showMessage('Error al confirmar el retiro. Por favor, inténtalo de nuevo.', 'error');
            }
        }

        /**
         * Rejects a pending withdrawal, deleting it from the list.
         * @param {string} withdrawalId The document ID of the pending withdrawal.
         * @param {string} userId The Firebase UID of the user who made the withdrawal.
         */
        async function rejectWithdrawal(withdrawalId, userId) {
            try {
                const withdrawalDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'pending_withdrawals', withdrawalId);
                // Optionally, in a real app, you might want to notify the user of rejection
                await deleteDoc(withdrawalDocRef);
                showMessage(`Retiro #${withdrawalId} rechazado exitosamente.`, 'info');
            } catch (error) {
                console.error("Error rejecting withdrawal:", error);
                showMessage('Error al rechazar el retiro. Por favor, inténtalo de nuevo.', 'error');
            }
        }


        // --- Event Listeners ---
        window.onload = () => {
             // onAuthStateChanged will handle the user's login state automatically
        };


        loginTab.addEventListener('click', () => toggleTabs('login'));
        registerTab.addEventListener('click', () => toggleTabs('register'));
        closeMessage.addEventListener('click', hideMessage);

        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        toggleCurrencyBtn.addEventListener('click', toggleCurrencyDisplay);

        // Rules Consent buttons
        acceptRulesBtn.addEventListener('click', () => {
            rulesConsentModal.classList.add('hidden');
            // Proceed with registration using stored data
            performRegistration(tempRegisterData.name, tempRegisterData.surname, tempRegisterData.age, tempRegisterData.password);
        });

        rejectRulesBtn.addEventListener('click', () => {
            rulesConsentModal.classList.add('hidden');
            showMessage('Debes aceptar las reglas para registrarte en el Banco Juvenil.', 'error');
            registerForm.reset(); // Clear the form if rules are rejected
            tempRegisterData = {}; // Clear temporary data
        });


        // Admin Panel buttons
        adminPanelBtn.addEventListener('click', () => {
            showSection(adminSection, dashboardSection, loginSection, registerSection, rulesConsentModal);
            loadPendingDeposits(); // Load deposits when admin panel is shown
            loadPendingWithdrawals(); // Load withdrawals when admin panel is shown
        });
        backToDashboardBtn.addEventListener('click', () => {
            showSection(dashboardSection, adminSection, loginSection, registerSection, rulesConsentModal);
        });

    </script>
</body>
</html>
