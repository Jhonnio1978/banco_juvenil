<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco Juvenil</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0px 10px -5px rgba(0, 0, 0, 0.04); /* Deeper shadow */
        }
        .btn-primary {
            background-image: linear-gradient(to right, #4F46E5, #6366F1); /* Gradient for primary buttons */
            color: white;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .input-field {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 1px solid #D1D5DB; /* Light gray border */
            width: 100%;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-field:focus {
            outline: none;
            border-color: #6366F1; /* Blue border on focus */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Light blue shadow on focus */
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            color: #6B7280; /* Gray text */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #6366F1;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tab-button:not(.active):hover {
            background-color: #F3F4F6; /* Light gray on hover for inactive tabs */
        }
        .hidden {
            display: none;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #E5E7EB; /* Light gray border */
        }
        th {
            background-color: #F9FAFB; /* Light header background */
            font-weight: 600;
            color: #4B5563; /* Darker gray text */
        }
        tr:hover {
            background-color: #F3F4F6; /* Light gray on row hover */
        }
        .btn-danger {
            background-color: #EF4444; /* Red */
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-danger:hover {
            background-color: #DC2626; /* Darker red */
            transform: translateY(-1px);
        }
        .btn-success {
            background-color: #22C55E; /* Green */
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-success:hover {
            background-color: #16A34A; /* Darker green */
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #6B7280; /* Gray */
            color: white;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
            background-color: #4B5563;
        }
        .modal-content {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 90%; /* Max width for responsiveness */
            width: 700px; /* Specific width for larger content */
            max-height: 90vh; /* Max height for scrollable content */
            overflow-y: auto; /* Enable scrolling for long content */
        }
    </style>
</head>
<body>
    <div class="container bg-gray-100">
        <div class="card p-8 md:p-10 w-full max-w-md mx-auto">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Banco Juvenil</h1>

            <div class="flex justify-center mb-6 bg-gray-50 rounded-xl p-1">
                <button id="loginTab" class="tab-button active flex-1">Iniciar Sesión</button>
                <button id="registerTab" class="tab-button flex-1">Registrarse</button>
            </div>

            <!-- Login Form -->
            <div id="loginSection">
                <p class="text-center text-gray-600 mb-6">¡Bienvenido de nuevo, campeón!</p>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="loginIdentifier" class="block text-gray-700 text-sm font-semibold mb-2">ID de Usuario (Email o ID único)</label>
                        <input type="text" id="loginIdentifier" class="input-field" placeholder="ej. JU#1234 o tu email" required>
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-gray-700 text-sm font-semibold mb-2">Contraseña</label>
                        <input type="password" id="loginPassword" class="input-field" placeholder="********" required>
                    </div>
                    <button type="submit" class="btn-primary w-full">Iniciar Sesión</button>
                </form>
            </div>

            <!-- Registration Form -->
            <div id="registerSection" class="hidden">
                <p class="text-center text-gray-600 mb-6">¡Únete a la familia del Banco Juvenil!</p>
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label for="registerName" class="block text-gray-700 text-sm font-semibold mb-2">Nombre</label>
                        <input type="text" id="registerName" class="input-field" placeholder="Juan" required>
                    </div>
                    <div>
                        <label for="registerSurname" class="block text-gray-700 text-sm font-semibold mb-2">Apellido</label>
                        <input type="text" id="registerSurname" class="input-field" placeholder="Pérez" required>
                    </div>
                    <div>
                        <label for="registerAge" class="block text-gray-700 text-sm font-semibold mb-2">Edad</label>
                        <input type="number" id="registerAge" class="input-field" placeholder="18" min="0" required>
                    </div>
                    <div>
                        <label for="registerPassword" class="block text-gray-700 text-sm font-semibold mb-2">Contraseña</label>
                        <input type="password" id="registerPassword" class="input-field" placeholder="********" required>
                    </div>
                    <button type="submit" class="btn-primary w-full">Registrarse</button>
                </form>
            </div>

            <!-- Message Box -->
            <div id="messageBox" class="mt-6 p-4 rounded-lg text-sm hidden" role="alert">
                <p id="messageText"></p>
                <button id="closeMessage" class="float-right text-gray-600 hover:text-gray-900 font-bold ml-4">&times;</button>
            </div>

            <!-- User Dashboard (Hidden initially) -->
            <div id="dashboardSection" class="hidden mt-8 text-center">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Bienvenido, <span id="dashboardUserName"></span>!</h2>
                <p class="text-lg text-gray-700 mb-4">Tu ID de Usuario: <span id="dashboardDisplayId" class="font-mono bg-gray-100 p-2 rounded-md text-sm"></span></p>
                <div class="mt-6 p-6 bg-blue-50 border border-blue-200 rounded-xl text-blue-800">
                    <h3 class="text-xl font-bold mb-2">Saldo Actual:</h3>
                    <p id="accountBalance" class="text-3xl font-extrabold">$0.00 USD</p>
                    <button id="toggleCurrency" class="mt-3 text-blue-600 hover:underline">Cambiar a DOP</button>
                </div>
                <div class="mt-8 space-y-4">
                    <button id="transferMoneyBtn" class="btn-primary w-full">Transferir Dinero</button>
                    <button id="depositMoneyBtn" class="btn-primary w-full">Depositar Dinero</button>
                    <button id="withdrawMoneyBtn" class="btn-primary w-full">Retirar Dinero</button>
                    <button id="viewHistoryBtn" class="btn-primary w-full bg-blue-600 hover:bg-blue-700">Ver Historial de Movimientos</button>

                    <!-- User-specific Pending Requests Button -->
                    <button id="viewUserPendingRequestsBtn" class="btn-primary w-full bg-purple-600 hover:bg-purple-700">Ver Mis Solicitudes Pendientes</button>

                    <!-- Online Shopping Button -->
                    <button id="onlineShoppingBtn" class="btn-primary w-full bg-teal-600 hover:bg-teal-700">Comprar por Internet</button>
                    <!-- Streaming Service Button -->
                    <button id="streamingPaymentBtn" class="btn-primary w-full bg-pink-600 hover:bg-pink-700">Pagar Servicio de Streaming</button>

                    <!-- Admin specific buttons, initially hidden -->
                    <div id="adminButtonsContainer" class="hidden space-y-4 mt-6 border-t pt-4 border-gray-200">
                        <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Funciones de Administrador</h3>
                        <button id="viewAdminPendingRequestsBtn" class="btn-primary w-full bg-teal-800 hover:bg-teal-900">Ver Solicitudes Pendientes (Admin)</button>
                        <button id="adminFullHistoryBtn" class="btn-primary w-full bg-green-600 hover:bg-green-700">Ver Historial Completo (Admin)</button>
                    </div>

                    <!-- FAQ button visible to all logged-in users -->
                    <button id="viewFAQBtn" class="btn-primary w-full bg-indigo-600 hover:bg-indigo-700 mt-4">Ver Preguntas Frecuentes (FAQ)</button>

                    <!-- Admin Contact info visible to all logged-in users -->
                    <p class="text-sm text-gray-600 mt-6 pt-4 border-t border-gray-200">
                        Contacto de Soporte (Admin): <a href="https://wa.me/18293329545" target="_blank" class="font-bold text-green-600 hover:underline">829-332-9545 (WhatsApp)</a>
                    </p>
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl shadow transition duration-200 w-full">Cerrar Sesión</button>
                </div>

                <!-- Transfer Money Modal -->
                <div id="transferModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
                    <div class="modal-content p-8 w-full max-w-sm">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Transferir Dinero</h3>
                        <form id="transferForm" class="space-y-4">
                            <div>
                                <label for="transferRecipientId" class="block text-gray-700 text-sm font-semibold mb-2">ID de Destinatario (Email o ID único)</label>
                                <input type="text" id="transferRecipientId" class="input-field" placeholder="ej. MA#5678 o email@banco.com" required>
                                <p id="recipientNameDisplay" class="text-xs text-gray-500 mt-1"></p>
                            </div>
                            <div>
                                <label for="transferAmount" class="block text-gray-700 text-sm font-semibold mb-2">Monto</label>
                                <input type="number" id="transferAmount" class="input-field" placeholder="100.00" min="0.01" step="0.01" required>
                            </div>
                            <div>
                                <label for="transferCurrency" class="block text-gray-700 text-sm font-semibold mb-2">Moneda</label>
                                <select id="transferCurrency" class="input-field">
                                    <option value="USD">Dólar (USD)</option>
                                    <option value="DOP">Peso Dominicano (DOP)</option>
                                </select>
                            </div>
                            <div class="flex justify-end space-x-4">
                                <button type="button" id="cancelTransferModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-xl shadow transition duration-200">Cancelar</button>
                                <button type="submit" id="confirmTransferBtn" class="btn-primary" disabled>Confirmar Transferencia</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Deposit Money Modal -->
                <div id="depositModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
                    <div class="modal-content p-8 w-full max-w-sm">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Depositar Dinero</h3>
                        <form id="depositForm" class="space-y-4">
                            <div>
                                <label for="depositSerialNumber" class="block text-gray-700 text-sm font-semibold mb-2">Número de Serie Único (Generado)</label>
                                <input type="text" id="depositSerialNumber" class="input-field" readonly>
                            </div>
                            <div>
                                <label for="depositAmount" class="block text-gray-700 text-sm font-semibold mb-2">Monto</label>
                                <input type="number" id="depositAmount" class="input-field" placeholder="Ej: 500.00" min="0.01" step="0.01" required>
                            </div>
                            <div>
                                <label for="depositCurrency" class="block text-gray-700 text-sm font-semibold mb-2">Moneda</label>
                                <select id="depositCurrency" class="input-field">
                                    <option value="USD">Dólar (USD)</option>
                                    <option value="DOP">Peso Dominicano (DOP)</option>
                                </select>
                            </div>
                            <div class="flex justify-end space-x-4">
                                <button type="button" id="cancelDeposit" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-xl shadow transition duration-200">Cancelar</button>
                                <button type="submit" class="btn-primary">Solicitar Depósito</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Withdraw Money Modal -->
                <div id="withdrawModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
                    <div class="modal-content p-8 w-full max-w-sm">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Retirar Dinero</h3>
                        <form id="withdrawForm" class="space-y-4">
                            <div>
                                <label for="withdrawAmount" class="block text-gray-700 text-sm font-semibold mb-2">Monto</label>
                                <input type="number" id="withdrawAmount" class="input-field" placeholder="Ej: 200.00" min="0.01" step="0.01" required>
                            </div>
                            <div>
                                <label for="withdrawCurrency" class="block text-gray-700 text-sm font-semibold mb-2">Moneda</label>
                                <select id="withdrawCurrency" class="input-field">
                                    <option value="USD">Dólar (USD)</option>
                                    <option value="DOP">Peso Dominicano (DOP)</option>
                                </select>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">Se aplicará una tarifa del 4% a este retiro.</p>
                            <div class="flex justify-end space-x-4">
                                <button type="button" id="cancelWithdraw" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-xl shadow transition duration-200">Cancelar</button>
                                <button type="submit" class="btn-primary">Solicitar Retiro</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- User History Modal -->
                <div id="userHistoryModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
                    <div class="modal-content p-8">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800 text-center">Mi Historial de Movimientos</h3>
                        <div class="table-container bg-white rounded-lg shadow">
                            <table class="min-w-full">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Tipo</th>
                                        <th>Detalle</th>
                                        <th>Monto</th>
                                        <th>Moneda</th>
                                    </tr>
                                </thead>
                                <tbody id="userHistoryTableBody">
                                    <tr><td colspan="5" class="text-center text-gray-500 py-4">Cargando historial...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <button id="closeUserHistoryModalBtn" class="btn-primary w-full mt-6">Cerrar Historial</button>
                    </div>
                </div>

                <!-- Transfer/Deposit/Withdrawal Status Message (for 10-second transfers or pending deposits) -->
                <div id="transactionStatusMsg" class="mt-6 p-4 rounded-lg text-sm hidden bg-yellow-100 border border-yellow-200 text-yellow-800" role="status">
                    <p id="transactionStatusText"></p>
                    <button id="cancelOngoingTransferBtn" class="mt-2 btn-secondary hidden">Cancelar Transferencia</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Admin Full History Modal -->
    <div id="adminFullHistoryModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
        <div class="modal-content p-8">
            <h3 class="text-2xl font-bold mb-4 text-gray-800 text-center">Historial Completo de Transacciones (Admin)</h3>
            <div class="table-container bg-white rounded-lg shadow">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Usuario (Remitente/Receptor)</th>
                            <th>Monto</th>
                            <th>Moneda</th>
                            <th>Estado</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody id="adminFullHistoryTableBodyModal">
                        <tr><td colspan="7" class="text-center text-gray-500 py-4">Cargando historial completo...</td></tr>
                    </tbody>
                </table>
            </div>
            <button id="closeAdminFullHistoryModalBtn" class="btn-primary w-full mt-6">Cerrar Historial Completo</button>
        </div>
    </div>

    <!-- Admin Pending Requests Modal (Unified for deposits, withdrawals, online shopping, streaming) -->
    <div id="adminPendingRequestsModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
        <div class="modal-content p-8">
            <h3 class="text-2xl font-bold mb-4 text-gray-800 text-center">Solicitudes Pendientes (Admin)</h3>
            <div class="table-container bg-white rounded-lg shadow">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Usuario</th>
                            <th>Monto</th>
                            <th>Moneda</th>
                            <th>Detalles</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="adminPendingRequestsTableBody">
                        <tr><td colspan="7" class="text-center text-gray-500 py-4">No hay solicitudes pendientes.</td></tr>
                    </tbody>
                </table>
            </div>
            <button id="closeAdminPendingRequestsModalBtn" class="btn-primary w-full mt-6">Cerrar</button>
        </div>
    </div>

    <!-- FAQ Modal -->
    <div id="faqModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
        <div class="modal-content p-8">
            <h3 class="text-2xl font-bold mb-4 text-gray-800 text-center">Preguntas Frecuentes (FAQ)</h3>
            <div class="text-left text-gray-700 space-y-4">
                <div>
                    <h4 class="font-semibold text-lg text-gray-800 mb-1">¿Cómo puedo registrarme?</h4>
                    <p class="text-sm">Para registrarte, ve a la pestaña "Registrarse" y completa tus datos. Se te asignará un ID de usuario único.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-gray-800 mb-1">¿Qué monedas puedo usar?</h4>
                    <p class="text-sm">Actualmente, el Banco Juvenil maneja Dólares (USD) y Pesos Dominicanos (DOP). Puedes ver y cambiar tu preferencia de moneda en tu dashboard.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-gray-800 mb-1">¿Cuánto tiempo tardan las transferencias?</h4>
                    <p class="text-sm">Las transferencias entre cuentas toman aproximadamente 10 segundos en procesarse. Una vez iniciada, no se puede cancelar.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-gray-800 mb-1">¿Cómo funciona el depósito de dinero?</h4>
                    <p class="text-sm">Para depositar dinero, solicitas un depósito con un número de serie único. Esta solicitud debe ser aprobada por un administrador del banco antes de que el dinero se refleje en tu cuenta.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-gray-800 mb-1">¿Hay alguna tarifa por retiro?</h4>
                    <p class="text-sm">Sí, se aplica una tarifa del 4% a todas las solicitudes de retiro para cubrir los costos de procesamiento.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-gray-800 mb-1">¿Cómo me contacto con el administrador si tengo un problema?</h4>
                    <p class="text-sm">Puedes contactar al administrador directamente al número: <span class="font-bold">829-332-9545</span>.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-gray-800 mb-1">¿Cómo funciona la compra por internet?</h4>
                    <p class="text-sm">Puedes solicitar la compra de productos de tiendas como Shein, Alibaba, AliExpress o Temu. Proporciona el monto estimado y los enlaces de los productos. Se te cobrará una tarifa del 3% sobre el total. **Tu solicitud será revisada y confirmada por el administrador antes de que se deduzca el dinero de tu cuenta.**</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-gray-800 mb-1">¿Cómo puedo pagar servicios de streaming?</h4>
                    <p class="text-sm">Puedes pagar tus suscripciones a servicios como Netflix, Disney+, Spotify, etc. Introduce el nombre del servicio, tu usuario/email de cuenta y el monto. Se aplicará una tarifa del 3%. **Tu solicitud será revisada y confirmada por el administrador antes de que se deduzca el dinero de tu cuenta.**</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-gray-800 mb-1">¿Puedo ver mis solicitudes de depósito y retiro pendientes?</h4>
                    <p class="text-sm">Sí, en tu dashboard puedes hacer clic en "Ver Mis Solicitudes Pendientes" para revisar el estado de todas tus solicitudes (depósitos, retiros, compras y pagos de streaming) que aún no han sido procesadas por el administrador.</p>
                </div>
            </div>
            <button id="closeFAQModalBtn" class="btn-primary w-full mt-6">Cerrar FAQ</button>
        </div>
    </div>

    <!-- Online Shopping Modal -->
    <div id="onlineShoppingModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
        <div class="modal-content p-8 w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-4 text-gray-800 text-center">Compra por Internet</h3>
            <form id="onlineShoppingForm" class="space-y-4">
                <div>
                    <label for="shoppingAmount" class="block text-gray-700 text-sm font-semibold mb-2">Monto total estimado de los productos (sin incluir envío/impuestos)</label>
                    <input type="number" id="shoppingAmount" class="input-field" placeholder="Ej: 50.00" min="0.01" step="0.01" required>
                </div>
                <div>
                    <label for="shoppingCurrency" class="block text-gray-700 text-sm font-semibold mb-2">Moneda</label>
                    <select id="shoppingCurrency" class="input-field">
                        <option value="USD">Dólar (USD)</option>
                        <option value="DOP">Peso Dominicano (DOP)</option>
                    </select>
                </div>
                <div>
                    <label for="productLinks" class="block text-gray-700 text-sm font-semibold mb-2">Pegue aquí los enlaces de los productos (uno por línea)</label>
                    <textarea id="productLinks" class="input-field h-32" placeholder="https://www.shein.com/item1&#10;https://www.aliexpress.com/item2" required></textarea>
                </div>
                <div class="text-right text-sm text-gray-600">
                    <p>Tarifa (3%): <span id="shoppingFeeDisplay">$0.00 USD</span></p>
                    <p class="font-bold text-base text-gray-800">Total Solicitado: <span id="shoppingTotalDisplay">$0.00 USD</span></p>
                    <p class="text-xs text-red-500 mt-1">Este monto será deducido de tu cuenta SÓLO después de la aprobación del administrador.</p>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelOnlineShopping" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-xl shadow transition duration-200">Cancelar</button>
                    <button type="submit" id="requestOnlineShopping" class="btn-primary">Enviar Solicitud de Compra</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Streaming Payment Modal -->
    <div id="streamingPaymentModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
        <div class="modal-content p-8 w-full max-w-sm">
            <h3 class="text-2xl font-bold mb-4 text-gray-800 text-center">Pagar Servicio de Streaming</h3>
            <form id="streamingPaymentForm" class="space-y-4">
                <div>
                    <label for="streamingService" class="block text-gray-700 text-sm font-semibold mb-2">Servicio de Streaming</label>
                    <select id="streamingService" class="input-field" required>
                        <option value="">Seleccione un servicio</option>
                        <option value="Netflix">Netflix</option>
                        <option value="Disney+">Disney+</option>
                        <option value="Spotify">Spotify</option>
                        <option value="Amazon Prime Video">Amazon Prime Video</option>
                        <option value="YouTube Premium">YouTube Premium</option>
                        <option value="HBO Max">HBO Max</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div>
                    <label for="streamingAccountIdentifier" class="block text-gray-700 text-sm font-semibold mb-2">Email o Usuario de la Cuenta</label>
                    <input type="text" id="streamingAccountIdentifier" class="input-field" placeholder="tu_email@ejemplo.com o tu_usuario" required>
                </div>
                <div>
                    <label for="streamingAmount" class="block text-gray-700 text-sm font-semibold mb-2">Monto de la Suscripción</label>
                    <input type="number" id="streamingAmount" class="input-field" placeholder="Ej: 15.99" min="0.01" step="0.01" required>
                </div>
                <div>
                    <label for="streamingCurrency" class="block text-gray-700 text-sm font-semibold mb-2">Moneda</label>
                    <select id="streamingCurrency" class="input-field">
                        <option value="USD">Dólar (USD)</option>
                        <option value="DOP">Peso Dominicano (DOP)</option>
                    </select>
                </div>
                <div class="text-right text-sm text-gray-600">
                    <p>Tarifa (3%): <span id="streamingFeeDisplay">$0.00 USD</span></p>
                    <p class="font-bold text-base text-gray-800">Total Solicitado: <span id="streamingTotalDisplay">$0.00 USD</span></p>
                    <p class="text-xs text-red-500 mt-1">Este monto será deducido de tu cuenta SÓLO después de la aprobación del administrador.</p>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelStreamingPayment" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-xl shadow transition duration-200">Cancelar</button>
                    <button type="submit" id="requestStreamingPayment" class="btn-primary">Enviar Solicitud de Pago</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Pending Requests Modal -->
    <div id="userPendingRequestsModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
        <div class="modal-content p-8">
            <h3 class="text-2xl font-bold mb-4 text-gray-800 text-center">Mis Solicitudes Pendientes</h3>
            <div class="table-container bg-white rounded-lg shadow">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Monto</th>
                            <th>Moneda</th>
                            <th>Estado</th>
                            <th>Detalle</th>
                        </tr>
                    </thead>
                    <tbody id="userPendingRequestsTableBody">
                        <tr><td colspan="6" class="text-center text-gray-500 py-4">Cargando solicitudes pendientes...</td></tr>
                    </tbody>
                </table>
            </div>
            <button id="closeUserPendingRequestsModalBtn" class="btn-primary w-full mt-6">Cerrar</button>
        </div>
    </div>

    <!-- Receipt/Invoice Modal for Users -->
    <div id="receiptModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
        <div class="modal-content p-8 w-full max-w-md">
            <h3 class="text-2xl font-bold mb-4 text-gray-800 text-center">Recibo de Transacción</h3>
            <div id="receiptContent" class="text-left text-gray-700 space-y-2 text-sm bg-gray-50 p-4 rounded-lg">
                <!-- Receipt details will be inserted here by JS -->
            </div>
            <button id="closeReceiptModalBtn" class="btn-primary w-full mt-6">Cerrar Recibo</button>
        </div>
    </div>


    <!-- Rules Consent Modal -->
    <div id="rulesConsentModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
        <div class="modal-content p-8 w-full max-w-md">
            <h3 class="text-2xl font-bold mb-4 text-gray-800 text-center">Reglas del Banco Juvenil</h3>
            <div id="briefRulesTextContainer" class="max-h-60 overflow-y-auto text-gray-700 text-sm mb-6 p-4 border rounded-lg bg-gray-50">
                <!-- Brief rules will be inserted here by JS -->
            </div>
            <div class="flex justify-end space-x-4">
                <button type="button" id="rejectRulesBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl shadow transition duration-200">Rechazar</button>
                <button type="button" id="acceptRulesBtn" class="btn-primary">Aceptar Reglas</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, serverTimestamp, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Your web app's Firebase configuration - provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyDfUxqjfr1UYo9KN1HwibNIXyAKSZCqYbw",
            authDomain: "banco-juvenil-12903.firebaseapp.com",
            projectId: "banco-juvenil-12903",
            storageBucket: "banco-juvenil-12903.firebaseapp.com",
            messagingSenderId: "421654654501",
            appId: "1:421654654501:web:c315e4d67c9289f6d619cc"
        };
        const appId = "banco-juvenil-12903"; // Using projectId as appId for Firestore path consistency

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null; // Stores the current authenticated user object
        let currentUserId = null; // Stores the UID of the current user (Firebase UID)
        let currentBalanceUSD = 0;
        let currentBalanceDOP = 0;
        let showCurrencyUSD = true; // Flag to toggle currency display

        // Exchange rate (example, in a real app this would come from an API)
        const USD_TO_DOP_RATE = 58.0; // Example rate
        const COMMISSION_RATE = 0.03; // 3% commission for online shopping and streaming
        const WITHDRAWAL_FEE_RATE = 0.04; // 4% fee for withdrawals

        // Admin email for prototype purposes
        const ADMIN_EMAIL = `admin.jhonnio@${appId}.com`;
        const ADMIN_PHONE_NUMBER_FULL = '18293329545'; // Admin's WhatsApp number with country code

        // Transfer specific variables
        let transferInterval = null; // To hold the interval ID for cancellation
        let currentTransferRecipientUid = null; // To store recipient UID for transfer confirmation
        let currentTransferAmount = 0;
        let currentTransferCurrency = '';
        let currentTransferRecipientIdentifier = ''; // The ID or email the user typed
        let currentTransferRecipientDisplayName = ''; // The name displayed to the user

        // Global map to store user display names to avoid repeated Firestore lookups
        const userDisplayNamesCache = {};

        // UI Elements
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const adminButtonsContainer = document.getElementById('adminButtonsContainer'); // Container for admin buttons

        const loginForm = document.getElementById('loginForm');
        const loginIdentifierInput = document.getElementById('loginIdentifier');
        const registerForm = document.getElementById('registerForm');
        const registerNameInput = document.getElementById('registerName');
        const registerSurnameInput = document.getElementById('registerSurname');
        const registerAgeInput = document.getElementById('registerAge');
        const registerPasswordInput = document.getElementById('registerPassword');

        const logoutBtn = document.getElementById('logoutBtn');
        const dashboardUserName = document.getElementById('dashboardUserName');
        const dashboardDisplayId = document.getElementById('dashboardDisplayId'); // Simplified user ID for display
        const accountBalance = document.getElementById('accountBalance');
        const toggleCurrencyBtn = document.getElementById('toggleCurrency');

        // Buttons
        const adminFullHistoryBtn = document.getElementById('adminFullHistoryBtn');
        const viewFAQBtn = document.getElementById('viewFAQBtn'); // FAQ Button
        const onlineShoppingBtn = document.getElementById('onlineShoppingBtn'); // Online Shopping Button
        const streamingPaymentBtn = document.getElementById('streamingPaymentBtn'); // Streaming Payment Button
        const viewUserPendingRequestsBtn = document.getElementById('viewUserPendingRequestsBtn'); // User Pending Requests Button
        const viewAdminPendingRequestsBtn = document.getElementById('viewAdminPendingRequestsBtn'); // Admin Pending Requests Button

        const adminFullHistoryTableBodyModal = document.getElementById('adminFullHistoryTableBodyModal'); // Admin History (in modal)

        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessage = document.getElementById('closeMessage');
        const transactionStatusMsg = document.getElementById('transactionStatusMsg');
        const transactionStatusText = document.getElementById('transactionStatusText');
        const cancelOngoingTransferBtn = document.getElementById('cancelOngoingTransferBtn');

        // Rules Consent Modal elements
        const rulesConsentModal = document.getElementById('rulesConsentModal');
        const briefRulesTextContainer = document.getElementById('briefRulesTextContainer');
        const acceptRulesBtn = document.getElementById('acceptRulesBtn');
        const rejectRulesBtn = document.getElementById('rejectRulesBtn');

        // Store registration form data temporarily for rules consent
        let tempRegisterData = {};

        // Define brief rules text (updated to reflect new pending approval flows)
        const briefRulesText = `
            <p class="mb-2"><strong>1. Seguridad de Cuenta:</strong> Tu contraseña es confidencial. Nunca la compartas. Eres responsable de la seguridad de tu ID de usuario y contraseña.</p>
            <p class="mb-2"><strong>2. Edad Mínima:</strong> Debes tener al menos 13 años para registrarte.</p>
            <p class="mb-2"><strong>3. Monedas:</strong> Manejamos USD y DOP. Las tasas de cambio aplican para conversiones.</p>
            <p class="mb-2"><strong>4. Depósitos:</strong> Todos los depósitos requieren aprobación del banco. No podrás hacer otro depósito si tienes uno pendiente.</p>
            <p class="mb-2"><strong>5. Retiros:</strong> Las solicitudes de retiro también requieren aprobación del banco. Se aplicará una tarifa del 4% a cada retiro.</p>
            <p class="mb-2"><strong>6. Compras y Streaming:</strong> Las solicitudes de compra por internet y pago de servicios de streaming requieren la aprobación del administrador antes de que se deduzca el dinero.</p>
            <p><strong>7. Transferencias:</strong> Las transferencias tienen un tiempo de procesamiento de 10 segundos. Verifica bien al destinatario, no son reversibles.</p>
        `;

        // Modals
        const transferMoneyBtn = document.getElementById('transferMoneyBtn');
        const transferModal = document.getElementById('transferModal');
        const cancelTransferModalBtn = document.getElementById('cancelTransferModalBtn');
        const transferForm = document.getElementById('transferForm');
        const transferRecipientIdInput = document.getElementById('transferRecipientId');
        const recipientNameDisplay = document.getElementById('recipientNameDisplay');
        const confirmTransferBtn = document.getElementById('confirmTransferBtn');

        const depositMoneyBtn = document.getElementById('depositMoneyBtn');
        const depositModal = document.getElementById('depositModal');
        const cancelDeposit = document.getElementById('cancelDeposit');
        const depositForm = document.getElementById('depositForm');
        const depositSerialNumberInput = document.getElementById('depositSerialNumber');

        const withdrawMoneyBtn = document.getElementById('withdrawMoneyBtn');
        const withdrawModal = document.getElementById('withdrawModal');
        const cancelWithdraw = document.getElementById('cancelWithdraw');
        const withdrawForm = document.getElementById('withdrawForm');

        const userHistoryModal = document.getElementById('userHistoryModal');
        const userHistoryTableBody = document.getElementById('userHistoryTableBody');
        const closeUserHistoryModalBtn = document.getElementById('closeUserHistoryModalBtn');

        const adminFullHistoryModal = document.getElementById('adminFullHistoryModal');
        const closeAdminFullHistoryModalBtn = document.getElementById('closeAdminFullHistoryModalBtn');

        // Admin Pending Requests Modal elements
        const adminPendingRequestsModal = document.getElementById('adminPendingRequestsModal');
        const closeAdminPendingRequestsModalBtn = document.getElementById('closeAdminPendingRequestsModalBtn');
        const adminPendingRequestsTableBody = document.getElementById('adminPendingRequestsTableBody');

        const faqModal = document.getElementById('faqModal');
        const closeFAQModalBtn = document.getElementById('closeFAQModalBtn');

        const onlineShoppingModal = document.getElementById('onlineShoppingModal');
        const cancelOnlineShopping = document.getElementById('cancelOnlineShopping');
        const onlineShoppingForm = document.getElementById('onlineShoppingForm');
        const shoppingAmountInput = document.getElementById('shoppingAmount');
        const shoppingCurrencyInput = document.getElementById('shoppingCurrency');
        const productLinksInput = document.getElementById('productLinks');
        const shoppingFeeDisplay = document.getElementById('shoppingFeeDisplay');
        const shoppingTotalDisplay = document.getElementById('shoppingTotalDisplay');

        const streamingPaymentModal = document.getElementById('streamingPaymentModal');
        const cancelStreamingPayment = document.getElementById('cancelStreamingPayment');
        const streamingPaymentForm = document.getElementById('streamingPaymentForm');
        const streamingServiceInput = document.getElementById('streamingService');
        const streamingAccountIdentifierInput = document.getElementById('streamingAccountIdentifier');
        const streamingAmountInput = document.getElementById('streamingAmount');
        const streamingCurrencyInput = document.getElementById('streamingCurrency');
        const streamingFeeDisplay = document.getElementById('streamingFeeDisplay');
        const streamingTotalDisplay = document.getElementById('streamingTotalDisplay');

        const userPendingRequestsModal = document.getElementById('userPendingRequestsModal');
        const closeUserPendingRequestsModalBtn = document.getElementById('closeUserPendingRequestsModalBtn');
        const userPendingRequestsTableBody = document.getElementById('userPendingRequestsTableBody');

        const receiptModal = document.getElementById('receiptModal');
        const receiptContent = document.getElementById('receiptContent');
        const closeReceiptModalBtn = document.getElementById('closeReceiptModalBtn');


        // --- Utility Functions ---

        /**
         * Displays a message in the UI message box.
         * @param {string} msg The message to display.
         * @param {string} type The type of message (success, error, info).
         */
        function showMessage(msg, type = 'info') {
            messageText.textContent = msg;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');
            messageBox.classList.add('block');

            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else {
                messageBox.classList.add('bg-blue-100', 'text-blue-800');
            }
        }

        /**
         * Hides the UI message box.
         */
        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        /**
         * Displays a transaction status message.
         * @param {string} msg The message to display.
         */
        function showTransactionStatus(msg) {
            transactionStatusText.textContent = msg;
            transactionStatusMsg.classList.remove('hidden');
            // Show cancel button only if it's an actual transfer in progress
            cancelOngoingTransferBtn.classList.remove('hidden');
        }

        /**
         * Hides the transaction status message.
         */
        function hideTransactionStatus() {
            transactionStatusMsg.classList.add('hidden');
            cancelOngoingTransferBtn.classList.add('hidden');
        }

        /**
         * Shows a receipt modal with transaction details.
         * @param {Object} transactionDetails Object containing details for the receipt.
         */
        function showReceipt(transactionDetails) {
            let content = `<p class="font-bold text-lg mb-2">${transactionDetails.title}</p>`;
            content += `<p><strong>Fecha:</strong> ${transactionDetails.date}</p>`;
            content += `<p><strong>Tipo:</strong> ${transactionDetails.type}</p>`;
            content += `<p><strong>Monto Total:</strong> ${transactionDetails.amount.toFixed(2)} ${transactionDetails.currency}</p>`;

            if (transactionDetails.productAmount) {
                 content += `<p><strong>Monto Productos:</strong> ${transactionDetails.productAmount.toFixed(2)} ${transactionDetails.productCurrency}</p>`;
            }
            if (transactionDetails.feeAmount) {
                content += `<p><strong>Tarifa (${(COMMISSION_RATE * 100).toFixed(0)}%):</strong> ${transactionDetails.feeAmount.toFixed(2)} ${transaction.feeCurrency}</p>`;
            }
            if (transactionDetails.service) {
                content += `<p><strong>Servicio:</strong> ${transactionDetails.service}</p>`;
                content += `<p><strong>Cuenta:</strong> ${transactionDetails.accountIdentifier}</p>`;
            }
            if (transactionDetails.productLinks) {
                content += `<p><strong>Enlaces:</strong></p>`;
                transactionDetails.productLinks.split('\n').forEach(link => {
                    if (link.trim()) {
                        content += `<p class="ml-4 text-xs break-all"><a href="${link.trim()}" target="_blank" class="text-blue-500 hover:underline">${link.trim()}</a></p>`;
                    }
                });
            }
            content += `<p class="mt-4 font-bold">¡Gracias por usar Banco Juvenil!</p>`;

            receiptContent.innerHTML = content;
            receiptModal.classList.remove('hidden');
        }

        /**
         * Toggles visibility between sections.
         * @param {HTMLElement} showElement Element to show.
         * @param {HTMLElement} ...hideElements List of elements to hide.
         */
        function showSection(showElement, ...hideElements) {
            showElement.classList.remove('hidden');
            hideElements.forEach(el => el.classList.add('hidden'));
        }

        /**
         * Toggles the active state of login/register tabs.
         * @param {string} activeTabId 'login' or 'register'.
         */
        function toggleTabs(activeTabId) {
            if (activeTabId === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                // Hide all main sections and modals
                showSection(loginSection, registerSection, dashboardSection, rulesConsentModal, userHistoryModal, adminFullHistoryModal, adminPendingRequestsModal, faqModal, onlineShoppingModal, streamingPaymentModal, userPendingRequestsModal, receiptModal);
            } else {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                // Hide all main sections and modals
                showSection(registerSection, loginSection, dashboardSection, rulesConsentModal, userHistoryModal, adminFullHistoryModal, adminPendingRequestsModal, faqModal, onlineShoppingModal, streamingPaymentModal, userPendingRequestsModal, receiptModal);
            }
            hideMessage(); // Hide any previous messages when changing tabs
        }

        /**
         * Closes any open modal.
         */
        function closeModal(modalElement) {
            modalElement.classList.add('hidden');
        }

        /**
         * Generates a simple, readable ID for display purposes.
         * @param {string} name User's first name.
         * @param {string} surname User's last name.
         * @returns {string} A user-friendly display ID.
         */
        function generateUserDisplayId(name, surname) {
            const initials = `${name.substring(0, 1).toUpperCase()}${surname.substring(0, 1).toUpperCase()}`;
            const randomNumber = Math.floor(1000 + Math.random() * 9000); // 4-digit number
            return `${initials}#${randomNumber}`;
        }

        /**
         * Fetches a user's display name from cache or Firestore.
         * @param {string} userId The Firebase UID of the user.
         * @returns {Promise<string>} The user's display name (Name Surname (ID#ABCD)) or a truncated ID.
         */
        async function getUserDisplayName(userId) {
            // Check if userId matches the Firebase UID of the admin email
            const adminQuery = query(collection(db, 'artifacts', appId, 'users'), where('email', '==', ADMIN_EMAIL));
            const adminSnapshot = await getDocs(adminQuery);
            if (!adminSnapshot.empty && adminSnapshot.docs[0].id === userId) {
                return "Administrador";
            }

            if (userDisplayNamesCache[userId]) {
                return userDisplayNamesCache[userId];
            }
            try {
                const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    const displayName = `${userData.name} ${userData.surname} (${userData.userDisplayId || userData.userId.substring(0, 5) + '...'})`;
                    userDisplayNamesCache[userId] = displayName;
                    return displayName;
                }
            } catch (error) {
                console.error("Error fetching user display name:", error);
            }
            return `ID: ${userId.substring(0, 5)}...`; // Fallback to truncated Firebase UID
        }


        // --- Firebase Authentication & Firestore Operations ---

        /**
         * Handles new user registration form submission (initiates rules consent).
         * @param {Event} e Form submission event.
         */
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage();
            const name = registerNameInput.value.trim();
            const surname = registerSurnameInput.value.trim();
            const age = parseInt(registerAgeInput.value);
            const password = registerPasswordInput.value;

            if (!name || !surname || !password || isNaN(age) || age <= 0) {
                showMessage('Por favor, completa todos los campos correctamente.', 'error');
                return;
            }

            // Store data temporarily for use after rules consent
            tempRegisterData = { name, surname, age, password };

            // Show rules consent modal
            briefRulesTextContainer.innerHTML = briefRulesText;
            rulesConsentModal.classList.remove('hidden');
        });

        /**
         * Performs the actual user registration after rules consent.
         * @param {string} name User's name.
         * @param {string} surname User's surname.
         * @param {number} age User's age.
         * @param {string} password User's password.
         */
        async function performRegistration(name, surname, age, password) {
            // Generate email for Firebase Auth (internal use primarily)
            const generatedEmail = `${name.toLowerCase().replace(/\s/g, '')}.${surname.toLowerCase().replace(/\s/g, '')}@${appId}.com`;
            // Generate a simple, user-friendly ID for display
            const userDisplayId = generateUserDisplayId(name, surname);

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, generatedEmail, password);
                const user = userCredential.user;
                const userId = user.uid; // Firebase UID

                await setDoc(doc(db, 'artifacts', appId, 'users', userId), {
                    userId: userId, // Internal Firebase UID
                    userDisplayId: userDisplayId, // User-friendly display ID
                    name: name,
                    surname: surname,
                    age: age,
                    email: generatedEmail, // Primary login email
                    balanceUSD: 0,
                    balanceDOP: 0,
                    currencyPreference: 'USD',
                    hasPendingDeposit: false, // Keep this for specific deposit blocking
                    createdAt: serverTimestamp()
                });

                showMessage(`¡Registro exitoso, ${name}! Tu ID de usuario para iniciar sesión es: ${generatedEmail}. Tu ID público es: ${userDisplayId}. Por favor, anótalo.`, 'success');
                loginIdentifierInput.value = generatedEmail; // Pre-fill login field with generated email
                loginPassword.value = password; // Pre-fill password
                // No explicit toggleTabs('login') here, as onAuthStateChanged handles showing dashboard
                // if login is successful after registration automatically.

            } catch (error) {
                console.error("Error during registration:", error);
                let errorMessage = 'Error al registrar. Por favor, inténtalo de nuevo.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = `Ya existe una cuenta con este nombre y apellido (o email ${generatedEmail}). Prueba a iniciar sesión o usa otro nombre/apellido.`;
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'La contraseña debe tener al menos 6 caracteres.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Error en el formato del email generado. Contacta soporte.';
                } else if (error.code === 'auth/configuration-not-found') {
                    errorMessage = 'Error de configuración de autenticación. Asegúrate de que "Email/Password" esté habilitado en Firebase Auth.';
                }
                showMessage(errorMessage, 'error');
            } finally {
                tempRegisterData = {}; // Clear temporary data regardless of outcome
            }
        }


        /**
         * Handles user login, accepting email or Firebase UID.
         * @param {Event} e Form submission event.
         */
        async function handleLogin(e) {
            e.preventDefault();
            hideMessage();
            const identifier = loginIdentifierInput.value.trim(); // Can be email, userDisplayId, or Firebase UID
            const password = loginPassword.value;
            let emailToLogin = identifier;

            if (!identifier || !password) {
                showMessage('Por favor, ingresa tu ID de usuario y contraseña.', 'error');
                return;
            }

            try {
                // If the identifier does not look like an email, try to find the email by userDisplayId or Firebase UID
                if (!identifier.includes('@')) {
                    const usersCollectionRef = collection(db, 'artifacts', appId, 'users');
                    let querySnapshot;

                    // 1. Try to find by userDisplayId (preferred for user-friendliness)
                    let q = query(usersCollectionRef, where('userDisplayId', '==', identifier));
                    querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        // 2. If not found by userDisplayId, try to find by Firebase UID
                        q = query(usersCollectionRef, where('userId', '==', identifier));
                        querySnapshot = await getDocs(q);
                    }

                    if (querySnapshot.empty) {
                        showMessage('ID de usuario o contraseña incorrectos.', 'error');
                        return;
                    }
                    // Found user, get their associated email for Firebase Auth
                    emailToLogin = querySnapshot.docs[0].data().email;
                    if (!emailToLogin) {
                        showMessage('No se pudo encontrar el email asociado a este ID de usuario.', 'error');
                        return;
                    }
                }

                // Attempt to sign in with the determined email and password
                await signInWithEmailAndPassword(auth, emailToLogin, password);
                // The onAuthStateChanged listener will handle UI update if login is successful

            } catch (error) {
                console.error("Error during login:", error);
                let errorMessage = 'Error al iniciar sesión. Verifica tu ID de usuario y contraseña.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = 'ID de usuario o contraseña incorrectos.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'El formato del ID de usuario (email) es inválido.';
                } else if (error.code === 'auth/configuration-not-found') {
                    errorMessage = 'Error de configuración de autenticación. Asegúrate de que "Email/Password" esté habilitado en Firebase Auth.';
                }
                showMessage(errorMessage, 'error');
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                // The onAuthStateChanged listener will handle UI update
            } catch (error) {
                console.error("Error during logout:", error);
                showMessage('Error al cerrar sesión. Por favor, inténtalo de nuevo.', 'error');
            }
        }

        /**
         * Updates the balance display in the UI.
         */
        function updateBalanceDisplay() {
            if (showCurrencyUSD) {
                accountBalance.textContent = `$${currentBalanceUSD.toFixed(2)} USD`;
                toggleCurrencyBtn.textContent = 'Cambiar a DOP';
            } else {
                accountBalance.textContent = `RD$${currentBalanceDOP.toFixed(2)} DOP`;
                toggleCurrencyBtn.textContent = 'Cambiar a USD';
            }
        }

        /**
         * Handles toggling currency display in the dashboard.
         */
        function toggleCurrencyDisplay() {
            showCurrencyUSD = !showCurrencyUSD;
            updateBalanceDisplay();
        }

        /**
         * Listens for authentication state changes to update the UI.
         */
        onAuthStateChanged(auth, async (user) => {
            hideMessage(); // Clear any messages
            hideTransactionStatus(); // Clear any transaction status messages

            if (user) {
                // User is signed in
                currentUser = user;
                currentUserId = user.uid;

                // Listen for real-time updates to the user's profile in Firestore
                // Path: artifacts/{appId}/users/{userId}
                const userProfileRef = doc(db, 'artifacts', appId, 'users', currentUserId);
                onSnapshot(userProfileRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        dashboardUserName.textContent = userData.name || 'Usuario';
                        // Display the user-friendly ID, fallback to Firebase UID if not set
                        dashboardDisplayId.textContent = userData.userDisplayId || userData.userId;

                        currentBalanceUSD = userData.balanceUSD || 0;
                        currentBalanceDOP = userData.balanceDOP || 0;
                        updateBalanceDisplay();

                        // Check for pending deposits and disable deposit button if necessary
                        if (userData.hasPendingDeposit) {
                            depositMoneyBtn.disabled = true;
                            depositMoneyBtn.textContent = 'Depósito Pendiente...';
                            showMessage('Tienes un depósito pendiente de aprobación. No puedes hacer otro depósito hasta que se confirme el actual.', 'info');
                        } else {
                            depositMoneyBtn.disabled = false;
                            depositMoneyBtn.textContent = 'Depositar Dinero';
                        }

                        // Show admin specific buttons if current user is admin
                        if (currentUser.email === ADMIN_EMAIL) {
                            adminButtonsContainer.classList.remove('hidden'); // Show container for admin buttons
                        } else {
                            adminButtonsContainer.classList.add('hidden'); // Hide for non-admin
                        }

                    } else {
                        console.warn("User profile not found in Firestore for UID:", currentUserId);
                        // If user profile doesn't exist, sign out
                        handleLogout();
                    }
                }, (error) => {
                    console.error("Error listening to user profile:", error);
                    showMessage("Error al cargar los datos de tu perfil. Intenta recargar la página.", 'error');
                });

                // Display dashboard and hide login/register forms and all modals
                showSection(dashboardSection, loginSection, registerSection, rulesConsentModal, userHistoryModal, adminFullHistoryModal, adminPendingRequestsModal, faqModal, onlineShoppingModal, streamingPaymentModal, userPendingRequestsModal, receiptModal);

            } else {
                // User is signed out
                currentUser = null;
                currentUserId = null;
                dashboardUserName.textContent = '';
                dashboardDisplayId.textContent = ''; // Clear display ID
                accountBalance.textContent = '$0.00 USD';
                toggleCurrencyBtn.textContent = 'Cambiar a DOP';
                showCurrencyUSD = true; // Reset currency display preference
                toggleTabs('login'); // Go back to login tab
            }
        });


        // --- Transfer Money Functionality ---

        /**
         * Shows the transfer money modal and resets its state.
         */
        transferMoneyBtn.addEventListener('click', () => {
            transferModal.classList.remove('hidden');
            transferForm.reset();
            recipientNameDisplay.textContent = ''; // Clear previous recipient name
            confirmTransferBtn.disabled = true; // Disable confirm button initially
        });

        /**
         * Closes the transfer money modal.
         */
        cancelTransferModalBtn.addEventListener('click', () => {
            closeModal(transferModal);
            transferForm.reset();
            recipientNameDisplay.textContent = '';
            confirmTransferBtn.disabled = true;
        });

        // Event listener for recipient ID input to fetch name
        transferRecipientIdInput.addEventListener('input', async () => {
            const identifier = transferRecipientIdInput.value.trim();
            recipientNameDisplay.textContent = 'Buscando usuario...';
            confirmTransferBtn.disabled = true;
            currentTransferRecipientUid = null; // Reset UID on new input

            if (!identifier) {
                recipientNameDisplay.textContent = '';
                return;
            }

            let recipientData = null;
            let querySnapshot;

            // 1. Try to find by email
            if (identifier.includes('@')) {
                const q = query(collection(db, 'artifacts', appId, 'users'), where('email', '==', identifier));
                querySnapshot = await getDocs(q);
            } else {
                // 2. If not email, try to find by userDisplayId
                const q = query(collection(db, 'artifacts', appId, 'users'), where('userDisplayId', '==', identifier));
                querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    // 3. Finally, try to find by Firebase UID
                    const q2 = query(collection(db, 'artifacts', appId, 'users'), where('userId', '==', identifier));
                    querySnapshot = await getDocs(q2);
                }
            }

            if (!querySnapshot.empty) {
                recipientData = querySnapshot.docs[0].data();
                // Store the actual Firebase UID for transaction
                currentTransferRecipientUid = recipientData.userId;
                // Store the identifier the user typed for messaging
                currentTransferRecipientIdentifier = identifier;
                currentTransferRecipientDisplayName = `${recipientData.name} ${recipientData.surname}`;
                recipientNameDisplay.textContent = `Usuario: ${currentTransferRecipientDisplayName}`;
                confirmTransferBtn.disabled = false;

                // Prevent self-transfer
                if (currentTransferRecipientUid === currentUserId) {
                    recipientNameDisplay.textContent = '¡No puedes transferir dinero a tu propia cuenta!';
                    confirmTransferBtn.disabled = true;
                    currentTransferRecipientUid = null; // Invalidate recipient
                }
            } else {
                recipientNameDisplay.textContent = 'Usuario no encontrado.';
                confirmTransferBtn.disabled = true;
                currentTransferRecipientUid = null;
                currentTransferRecipientDisplayName = '';
            }
        });


        /**
         * Handles transfer form submission.
         * In a real environment, this SHOULD BE A FIREBASE CLOUD FUNCTION for security.
         */
        transferForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage();
            hideTransactionStatus();

            if (!currentTransferRecipientUid) {
                showMessage('Por favor, selecciona un destinatario válido.', 'error');
                return;
            }

            currentTransferAmount = parseFloat(transferAmount.value);
            currentTransferCurrency = transferCurrency.value;

            if (currentTransferAmount <= 0 || isNaN(currentTransferAmount)) {
                showMessage('El monto a transferir debe ser un número positivo.', 'error');
                return;
            }

            // Check sender's balance (currentBalanceUSD and currentBalanceDOP are already updated by onSnapshot)
            let senderBalance = currentTransferCurrency === 'USD' ? currentBalanceUSD : currentBalanceDOP;
            if (currentTransferAmount > senderBalance) {
                showMessage('Saldo insuficiente para realizar esta transferencia.', 'error');
                closeModal(transferModal); // Close modal on error
                return;
            }

            showMessage(`Iniciando transferencia de ${currentTransferAmount.toFixed(2)} ${currentTransferCurrency} a ${currentTransferRecipientDisplayName}... Por favor, espera 10 segundos.`, 'info');
            closeModal(transferModal); // Close the modal immediately
            showTransactionStatus(`Transferencia a ${currentTransferRecipientDisplayName} en proceso... (10 segundos restantes)`);
            transferForm.reset(); // Reset form fields
            recipientNameDisplay.textContent = ''; // Clear recipient name display
            confirmTransferBtn.disabled = true; // Disable button after submission

            // --- SIMULACIÓN DE 10 SEGUNDOS DE ESPERA ---
            let countdown = 10; // 10 seconds
            cancelOngoingTransferBtn.classList.remove('hidden'); // Show cancel button for ongoing transfer

            transferInterval = setInterval(() => {
                countdown--;
                if (countdown >= 0) {
                    transactionStatusText.textContent = `Transferencia a ${currentTransferRecipientDisplayName} en proceso... (${countdown} segundos restantes)`;
                }

                if (countdown <= 0) {
                    clearInterval(transferInterval);
                    transferInterval = null; // Clear interval ID
                    hideTransactionStatus(); // Hide status message
                    performTransfer(currentUserId, currentTransferRecipientUid, currentTransferAmount, currentTransferCurrency, currentTransferRecipientDisplayName);
                }
            }, 1000); // Update every second
        });

        // Cancel Ongoing Transfer button handler
        cancelOngoingTransferBtn.addEventListener('click', () => {
            if (transferInterval) {
                clearInterval(transferInterval);
                transferInterval = null; // Clear interval ID
                hideTransactionStatus();
                showMessage('Transferencia cancelada.', 'info');
                // Reset any state related to the transfer
                currentTransferRecipientUid = null;
                currentTransferAmount = 0;
                currentTransferCurrency = '';
                currentTransferRecipientIdentifier = '';
                currentTransferRecipientDisplayName = '';
            }
        });


        /**
         * Executes the actual transfer logic after the delay.
         * In a real environment, this SHOULD BE A FIREBASE CLOUD FUNCTION for security.
         * @param {string} senderUid Firebase UID of the sender.
         * @param {string} actualRecipientUid Firebase UID of the recipient.
         * @param {number} amount Amount to transfer.
         * @param {string} currency Currency of the transfer (USD/DOP).
         * @param {string} recipientDisplayName The name displayed to the user for the recipient.
         */
        async function performTransfer(senderUid, actualRecipientUid, amount, currency, recipientDisplayName) {
            try {
                const senderProfileRef = doc(db, 'artifacts', appId, 'users', senderUid);
                const recipientProfileRef = doc(db, 'artifacts', appId, 'users', actualRecipientUid);

                // Get current balances for transaction (ideally this entire block would be atomic in Cloud Function)
                const senderSnap = await getDoc(senderProfileRef);
                const recipientSnap = await getDoc(recipientProfileRef);

                if (!senderSnap.exists() || !recipientSnap.exists()) {
                    showMessage('Error: No se encontraron los perfiles de remitente o destinatario para completar la transferencia.', 'error');
                    return; // Do not proceed with transfer if profiles not found
                }

                const senderData = senderSnap.data();
                const recipientData = recipientSnap.data();

                let senderCurrentBalanceUSD = senderData.balanceUSD || 0;
                let senderCurrentBalanceDOP = senderData.balanceDOP || 0;
                let recipientCurrentBalanceUSD = recipientData.balanceUSD || 0;
                let recipientCurrentBalanceDOP = recipientData.balanceDOP || 0;

                // Convert amount to USD for internal calculation if currency is DOP
                let amountInUSD = amount;
                if (currency === 'DOP') {
                    amountInUSD = amount / USD_TO_DOP_RATE;
                }

                // Double check sender's balance
                if (senderCurrentBalanceUSD < amountInUSD) {
                    showMessage('Error: Saldo insuficiente para completar la transferencia (posiblemente ya gastado o error de concurrencia).', 'error');
                    return;
                }

                // Update sender's balance
                senderCurrentBalanceUSD -= amountInUSD;
                senderCurrentBalanceDOP = senderCurrentBalanceUSD * USD_TO_DOP_RATE;

                // Update recipient's balance
                recipientCurrentBalanceUSD += amountInUSD;
                recipientCurrentBalanceDOP = recipientCurrentBalanceUSD * USD_TO_DOP_RATE;

                // Perform updates in Firestore
                await updateDoc(senderProfileRef, {
                    balanceUSD: senderCurrentBalanceUSD,
                    balanceDOP: senderCurrentBalanceDOP
                });

                await updateDoc(recipientProfileRef, {
                    balanceUSD: recipientCurrentBalanceUSD,
                    balanceDOP: recipientCurrentBalanceDOP
                });

                // Record the transaction in a public collection
                // Path: artifacts/{appId}/public/data/transactions
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                    senderId: senderUid,
                    recipientId: actualRecipientUid,
                    amount: amount,
                    currency: currency,
                    timestamp: serverTimestamp(),
                    type: 'transfer',
                    status: 'completed',
                    description: `Transferencia a ${recipientDisplayName}`
                });

                showMessage(`Transferencia de ${amount.toFixed(2)} ${currency} a ${recipientDisplayName} completada exitosamente.`, 'success');
                // Balances will be updated automatically by the onSnapshot listener

            } catch (error) {
                console.error("Error al completar la transferencia:", error);
                showMessage('Error al procesar la transferencia. Por favor, inténtalo de nuevo.', 'error');
            } finally {
                // Ensure transaction status is hidden after completion or error
                hideTransactionStatus();
            }
        }


        // --- Deposit Money Functionality ---

        /**
         * Shows the deposit money modal with an auto-generated serial number.
         */
        depositMoneyBtn.addEventListener('click', () => {
            depositSerialNumberInput.value = crypto.randomUUID().substring(0, 8).toUpperCase(); // Generate a shorter unique ID
            depositModal.classList.remove('hidden');
        });

        /**
         * Closes the deposit money modal.
         */
        cancelDeposit.addEventListener('click', () => {
            closeModal(depositModal);
            depositForm.reset();
        });

        /**
         * Handles deposit form submission.
         * Requests are sent to pending_requests for admin approval.
         */
        depositForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage();
            hideTransactionStatus();

            const serialNumber = depositSerialNumberInput.value.trim();
            const amount = parseFloat(depositAmount.value);
            const currency = depositCurrency.value;

            if (amount <= 0 || isNaN(amount)) {
                showMessage('El monto debe ser un número positivo.', 'error');
                return;
            }
            if (!serialNumber) {
                showMessage('Por favor, ingresa un número de serie único para tu depósito.', 'error');
                return;
            }

            try {
                // Check if user already has a pending deposit (this specific flag is for deposits only)
                const userDocRef = doc(db, 'artifacts', appId, 'users', currentUserId);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists() && userDocSnap.data().hasPendingDeposit) {
                     showMessage('Ya tienes un depósito pendiente de aprobación. No puedes solicitar otro.', 'error');
                     closeModal(depositModal);
                     depositForm.reset();
                     return;
                }

                // Add deposit request to a unified 'pending_requests' collection
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pending_requests'), {
                    userId: currentUserId,
                    type: 'deposit', // Indicate request type
                    serialNumber: serialNumber,
                    amount: amount,
                    currency: currency,
                    timestamp: serverTimestamp(),
                    status: 'pending' // Status for admin approval
                });

                // Update user's profile to mark that they have a pending deposit
                await updateDoc(userDocRef, {
                    hasPendingDeposit: true
                });

                showMessage(`Solicitud de depósito de ${amount.toFixed(2)} ${currency} con número de serie ${serialNumber} enviada. Esperando aprobación del banco.`, 'success');
                closeModal(depositModal);
                depositForm.reset();

                // Send WhatsApp message to admin
                const userData = userDocSnap.data();
                const whatsappMessage = `
                Nueva solicitud de depósito pendiente:
                Usuario: ${userData.name} ${userData.surname} (ID: ${userData.userDisplayId || userData.userId})
                Monto: ${amount.toFixed(2)} ${currency}
                Número de Serie: ${serialNumber}
                Por favor, revisa y confirma.
                `;
                const encodedMessage = encodeURIComponent(whatsappMessage);
                window.open(`https://wa.me/${ADMIN_PHONE_NUMBER_FULL}?text=${encodedMessage}`, '_blank');

            } catch (error) {
                console.error("Error al solicitar depósito:", error);
                showMessage('Error al procesar la solicitud de depósito. Inténtalo de nuevo.', 'error');
            }
        });

        // --- Withdraw Money Functionality ---

        /**
         * Shows the withdraw money modal.
         */
        withdrawMoneyBtn.addEventListener('click', () => {
            withdrawModal.classList.remove('hidden');
        });

        /**
         * Closes the withdraw money modal.
         */
        cancelWithdraw.addEventListener('click', () => {
            closeModal(withdrawModal);
            withdrawForm.reset();
        });

        /**
         * Handles withdrawal form submission.
         * Requests are sent to pending_requests for admin approval.
         */
        withdrawForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage();
            hideTransactionStatus();

            const amount = parseFloat(withdrawAmount.value);
            const currency = withdrawCurrency.value;

            if (amount <= 0 || isNaN(amount)) {
                showMessage('El monto a retirar debe ser un número positivo.', 'error');
                return;
            }

            // Calculate estimated total including fee for display
            let amountInUSD = amount;
            if (currency === 'DOP') {
                amountInUSD = amount / USD_TO_DOP_RATE;
            }
            const estimatedFeeInUSD = amountInUSD * WITHDRAWAL_FEE_RATE;
            const totalRequiredForWithdrawalInUSD = amountInUSD + estimatedFeeInUSD;

            // Check if current balance is sufficient for estimation (final check at confirmation)
            if (currentBalanceUSD < totalRequiredForWithdrawalInUSD) {
                showMessage(`Saldo insuficiente para cubrir el retiro de ${amount.toFixed(2)} ${currency} y la tarifa del 4%. Necesitas $${totalRequiredForWithdrawalInUSD.toFixed(2)} USD.`, 'error');
                return;
            }

            try {
                // Add withdrawal request to a unified 'pending_requests' collection
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pending_requests'), {
                    userId: currentUserId,
                    type: 'withdrawal', // Indicate request type
                    amount: amount,
                    currency: currency,
                    timestamp: serverTimestamp(),
                    status: 'pending', // Status for admin approval
                    estimatedFee: estimatedFeeInUSD // Store estimated fee for admin review
                });

                showMessage(`Solicitud de retiro de ${amount.toFixed(2)} ${currency} enviada. Esperando aprobación del banco. Se aplicará una tarifa del 4% al confirmar.`, 'success');
                closeModal(withdrawModal);
                withdrawForm.reset();

                // Send WhatsApp message to admin
                const userDocSnap = await getDoc(doc(db, 'artifacts', appId, 'users', currentUserId));
                const userData = userDocSnap.data();
                const whatsappMessage = `
                Nueva solicitud de retiro pendiente:
                Usuario: ${userData.name} ${userData.surname} (ID: ${userData.userDisplayId || userData.userId})
                Monto: ${amount.toFixed(2)} ${currency}
                Tarifa estimada (4%): $${estimatedFeeInUSD.toFixed(2)} USD
                Por favor, revisa y confirma.
                `;
                const encodedMessage = encodeURIComponent(whatsappMessage);
                window.open(`https://wa.me/${ADMIN_PHONE_NUMBER_FULL}?text=${encodedMessage}`, '_blank');

            } catch (error) {
                console.error("Error al solicitar retiro:", error);
                showMessage('Error al procesar la solicitud de retiro. Inténtalo de nuevo.', 'error');
            }
        });

        // --- Online Shopping Logic ---
        onlineShoppingBtn.addEventListener('click', () => {
            onlineShoppingModal.classList.remove('hidden');
            onlineShoppingForm.reset();
            shoppingFeeDisplay.textContent = '$0.00 USD';
            shoppingTotalDisplay.textContent = '$0.00 USD';
        });

        cancelOnlineShopping.addEventListener('click', () => {
            closeModal(onlineShoppingModal);
            onlineShoppingForm.reset();
        });

        shoppingAmountInput.addEventListener('input', updateOnlineShoppingCalculation);
        shoppingCurrencyInput.addEventListener('change', updateOnlineShoppingCalculation);

        function updateOnlineShoppingCalculation() {
            const amount = parseFloat(shoppingAmountInput.value);
            const currency = shoppingCurrencyInput.value;

            if (isNaN(amount) || amount <= 0) {
                shoppingFeeDisplay.textContent = `$0.00 USD`;
                shoppingTotalDisplay.textContent = `$0.00 USD`;
                return;
            }

            let amountInUSD = amount;
            if (currency === 'DOP') {
                amountInUSD = amount / USD_TO_DOP_RATE;
            }

            const feeAmount = amountInUSD * COMMISSION_RATE;
            const totalAmount = amountInUSD + feeAmount; // This is what the user *will pay* after admin confirmation

            shoppingFeeDisplay.textContent = `$${feeAmount.toFixed(2)} USD`;
            shoppingTotalDisplay.textContent = `$${totalAmount.toFixed(2)} USD`;
        }

        onlineShoppingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage();

            const productAmount = parseFloat(shoppingAmountInput.value);
            const productCurrency = shoppingCurrencyInput.value;
            const productLinks = productLinksInput.value.trim();

            if (isNaN(productAmount) || productAmount <= 0) {
                showMessage('Por favor, ingresa un monto estimado válido para los productos.', 'error');
                return;
            }
            if (!productLinks) {
                showMessage('Por favor, ingresa al menos un enlace de producto.', 'error');
                return;
            }

            let amountInUSD = productAmount;
            if (productCurrency === 'DOP') {
                amountInUSD = productAmount / USD_TO_DOP_RATE;
            }

            const feeAmount = amountInUSD * COMMISSION_RATE;
            const totalToDeductInUSD = amountInUSD + feeAmount; // This is the total amount the user will pay

            try {
                // Add online purchase request to 'pending_requests'
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pending_requests'), {
                    userId: currentUserId,
                    type: 'online_purchase',
                    productAmount: productAmount,
                    productCurrency: productCurrency,
                    productLinks: productLinks,
                    feeAmount: feeAmount, // Store calculated fee
                    totalAmountToDeduct: totalToDeductInUSD, // Store total to deduct
                    timestamp: serverTimestamp(),
                    status: 'pending'
                });

                showMessage('Solicitud de compra por internet enviada. Esperando aprobación del administrador. El dinero se deducirá al confirmar.', 'info');
                closeModal(onlineShoppingModal);
                onlineShoppingForm.reset();

                // Send WhatsApp message to admin
                const userDocSnap = await getDoc(doc(db, 'artifacts', appId, 'users', currentUserId));
                const userData = userDocSnap.data();
                const whatsappMessage = `
                Nueva solicitud de compra online pendiente:
                Usuario: ${userData.name} ${userData.surname} (ID: ${userData.userDisplayId || userData.userId})
                Monto de productos: ${productAmount.toFixed(2)} ${productCurrency}
                Tarifa (3%): $${feeAmount.toFixed(2)} USD
                TOTAL A DEDUCIR: $${totalToDeductInUSD.toFixed(2)} USD (al confirmar)
                Enlaces de productos:
                ${productLinks}
                Por favor, revisa y confirma.
                `;
                const encodedMessage = encodeURIComponent(whatsappMessage);
                window.open(`https://wa.me/${ADMIN_PHONE_NUMBER_FULL}?text=${encodedMessage}`, '_blank');

            } catch (error) {
                console.error("Error al solicitar compra online:", error);
                showMessage('Error al procesar la solicitud de compra online. Por favor, inténtalo de nuevo.', 'error');
            }
        });

        // --- Streaming Payment Logic ---
        streamingPaymentBtn.addEventListener('click', () => {
            streamingPaymentModal.classList.remove('hidden');
            streamingPaymentForm.reset();
            streamingFeeDisplay.textContent = '$0.00 USD';
            streamingTotalDisplay.textContent = '$0.00 USD';
        });

        cancelStreamingPayment.addEventListener('click', () => {
            closeModal(streamingPaymentModal);
            streamingPaymentForm.reset();
        });

        streamingAmountInput.addEventListener('input', updateStreamingPaymentCalculation);
        streamingCurrencyInput.addEventListener('change', updateStreamingPaymentCalculation);

        function updateStreamingPaymentCalculation() {
            const amount = parseFloat(streamingAmountInput.value);
            const currency = streamingCurrencyInput.value;

            if (isNaN(amount) || amount <= 0) {
                streamingFeeDisplay.textContent = `$0.00 USD`;
                streamingTotalDisplay.textContent = `$0.00 USD`;
                return;
            }

            let amountInUSD = amount;
            if (currency === 'DOP') {
                amountInUSD = amount / USD_TO_DOP_RATE;
            }

            const feeAmount = amountInUSD * COMMISSION_RATE;
            const totalAmount = amountInUSD + feeAmount; // This is what the user *will pay* after admin confirmation

            streamingFeeDisplay.textContent = `$${feeAmount.toFixed(2)} USD`;
            streamingTotalDisplay.textContent = `$${totalAmount.toFixed(2)} USD`;
        }

        streamingPaymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage();

            const service = streamingServiceInput.value;
            const accountIdentifier = streamingAccountIdentifierInput.value.trim();
            const subscriptionAmount = parseFloat(streamingAmountInput.value);
            const subscriptionCurrency = streamingCurrencyInput.value;

            if (!service || !accountIdentifier || isNaN(subscriptionAmount) || subscriptionAmount <= 0) {
                showMessage('Por favor, completa todos los campos para el pago del servicio de streaming.', 'error');
                return;
            }

            let amountInUSD = subscriptionAmount;
            if (subscriptionCurrency === 'DOP') {
                amountInUSD = subscriptionAmount / USD_TO_DOP_RATE;
            }

            const feeAmount = amountInUSD * COMMISSION_RATE;
            const totalToDeductInUSD = amountInUSD + feeAmount; // This is the total amount the user will pay

            try {
                // Add streaming payment request to 'pending_requests'
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pending_requests'), {
                    userId: currentUserId,
                    type: 'streaming_payment',
                    service: service,
                    accountIdentifier: accountIdentifier,
                    subscriptionAmount: subscriptionAmount,
                    subscriptionCurrency: subscriptionCurrency,
                    feeAmount: feeAmount,
                    totalAmountToDeduct: totalToDeductInUSD,
                    timestamp: serverTimestamp(),
                    status: 'pending'
                });

                showMessage('Solicitud de pago de servicio de streaming enviada. Esperando aprobación del administrador. El dinero se deducirá al confirmar.', 'info');
                closeModal(streamingPaymentModal);
                streamingPaymentForm.reset();

                // Send WhatsApp message to admin
                const userDocSnap = await getDoc(doc(db, 'artifacts', appId, 'users', currentUserId));
                const userData = userDocSnap.data();
                const whatsappMessage = `
                Nueva solicitud de pago de streaming pendiente:
                Usuario: ${userData.name} ${userData.surname} (ID: ${userData.userDisplayId || userData.userId})
                Servicio: ${service}
                Cuenta: ${accountIdentifier}
                Monto Suscripción: ${subscriptionAmount.toFixed(2)} ${subscriptionCurrency}
                Tarifa (3%): $${feeAmount.toFixed(2)} USD
                TOTAL A DEDUCIR: $${totalToDeductInUSD.toFixed(2)} USD (al confirmar)
                Por favor, revisa y confirma.
                `;
                const encodedMessage = encodeURIComponent(whatsappMessage);
                window.open(`https://wa.me/${ADMIN_PHONE_NUMBER_FULL}?text=${encodedMessage}`, '_blank');

            } catch (error) {
                console.error("Error al solicitar pago de streaming:", error);
                showMessage('Error al procesar el pago de streaming. Por favor, inténtalo de nuevo.', 'error');
            }
        });

        // --- Admin Pending Requests Functionality (Unified) ---

        viewAdminPendingRequestsBtn.addEventListener('click', () => {
            adminPendingRequestsModal.classList.remove('hidden');
            loadAdminPendingRequests();
        });

        closeAdminPendingRequestsModalBtn.addEventListener('click', () => {
            closeModal(adminPendingRequestsModal);
        });

        /**
         * Loads and displays all pending requests for the admin.
         */
        function loadAdminPendingRequests() {
            adminPendingRequestsTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-4">Cargando solicitudes pendientes...</td></tr>';
            const pendingRequestsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'pending_requests');
            const q = query(pendingRequestsCollectionRef, where('status', '==', 'pending'));

            onSnapshot(q, async (snapshot) => {
                adminPendingRequestsTableBody.innerHTML = '';
                if (snapshot.empty) {
                    adminPendingRequestsTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-4">No hay solicitudes pendientes.</td></tr>';
                    return;
                }

                for (const docEntry of snapshot.docs) {
                    const request = docEntry.data();
                    const requestId = docEntry.id;

                    const userNameDisplay = await getUserDisplayName(request.userId);
                    const requestDate = (request.timestamp && typeof request.timestamp.seconds !== 'undefined')
                        ? new Date(request.timestamp.seconds * 1000).toLocaleString()
                        : 'Fecha no disponible';

                    let typeDisplay = '';
                    let amountDisplay = '';
                    let currencyDisplay = '';
                    let detailsDisplay = '';

                    switch (request.type) {
                        case 'deposit':
                            typeDisplay = 'Depósito';
                            amountDisplay = request.amount.toFixed(2);
                            currencyDisplay = request.currency;
                            detailsDisplay = `Serie: ${request.serialNumber}`;
                            break;
                        case 'withdrawal':
                            typeDisplay = 'Retiro';
                            amountDisplay = request.amount.toFixed(2);
                            currencyDisplay = request.currency;
                            detailsDisplay = `Tarifa est. (4%): $${request.estimatedFee ? request.estimatedFee.toFixed(2) : '0.00'} USD`;
                            break;
                        case 'online_purchase':
                            typeDisplay = 'Compra Online';
                            amountDisplay = request.totalAmountToDeduct.toFixed(2); // Show total amount to be deducted
                            currencyDisplay = 'USD'; // Assuming totalToDeduct is in USD
                            detailsDisplay = `Prod. Cant: ${request.productAmount.toFixed(2)} ${request.productCurrency}, Tarifa (3%): $${request.feeAmount.toFixed(2)} USD. Links: ${request.productLinks.substring(0, 50)}...`;
                            break;
                        case 'streaming_payment':
                            typeDisplay = 'Pago Streaming';
                            amountDisplay = request.totalAmountToDeduct.toFixed(2); // Show total amount to be deducted
                            currencyDisplay = 'USD'; // Assuming totalToDeduct is in USD
                            detailsDisplay = `Servicio: ${request.service}, Cuenta: ${request.accountIdentifier}, Tarifa (3%): $${request.feeAmount.toFixed(2)} USD.`;
                            break;
                        default:
                            typeDisplay = 'Desconocido';
                            amountDisplay = request.amount ? request.amount.toFixed(2) : 'N/A';
                            currencyDisplay = request.currency || 'N/A';
                            detailsDisplay = 'N/A';
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${requestDate}</td>
                        <td>${typeDisplay}</td>
                        <td>${userNameDisplay}</td>
                        <td>${amountDisplay}</td>
                        <td>${currencyDisplay}</td>
                        <td>${detailsDisplay}</td>
                        <td>
                            <button class="btn-success confirm-request-btn"
                                data-request-id="${requestId}"
                                data-user-id="${request.userId}"
                                data-type="${request.type}"
                                data-amount="${request.amount}"
                                data-currency="${request.currency}"
                                data-serial-number="${request.serialNumber || ''}"
                                data-product-amount="${request.productAmount || 0}"
                                data-product-currency="${request.productCurrency || ''}"
                                data-product-links="${request.productLinks || ''}"
                                data-service="${request.service || ''}"
                                data-account-identifier="${request.accountIdentifier || ''}"
                                data-subscription-amount="${request.subscriptionAmount || 0}"
                                data-subscription-currency="${request.subscriptionCurrency || ''}"
                                data-fee-amount="${request.feeAmount || 0}"
                                data-total-amount-to-deduct="${request.totalAmountToDeduct || 0}"
                                >Confirmar</button>
                            <button class="btn-danger reject-request-btn"
                                data-request-id="${requestId}"
                                data-user-id="${request.userId}"
                                data-type="${request.type}"
                                >Rechazar</button>
                        </td>
                    `;
                    adminPendingRequestsTableBody.appendChild(row);
                }

                // Attach event listeners for dynamic buttons
                document.querySelectorAll('.confirm-request-btn').forEach(button => {
                    button.onclick = async (event) => {
                        const dataset = event.target.dataset;
                        await confirmRequest(
                            dataset.requestId,
                            dataset.type,
                            dataset.userId,
                            parseFloat(dataset.amount),
                            dataset.currency,
                            dataset.serialNumber,
                            parseFloat(dataset.productAmount),
                            dataset.productCurrency,
                            dataset.productLinks,
                            dataset.service,
                            dataset.accountIdentifier,
                            parseFloat(dataset.subscriptionAmount),
                            dataset.subscriptionCurrency,
                            parseFloat(dataset.feeAmount),
                            parseFloat(dataset.totalAmountToDeduct)
                        );
                    };
                });
                document.querySelectorAll('.reject-request-btn').forEach(button => {
                    button.onclick = async (event) => {
                        const dataset = event.target.dataset;
                        await rejectRequest(dataset.requestId, dataset.type, dataset.userId);
                    };
                });
            });
        }

        /**
         * Confirms a pending request, handles money transfer, and records transaction.
         */
        async function confirmRequest(
            requestId, type, userId, amount, currency, serialNumber,
            productAmount, productCurrency, productLinks,
            service, accountIdentifier, subscriptionAmount, subscriptionCurrency,
            feeAmount, totalAmountToDeduct
        ) {
            console.log("Confirming request:", { requestId, type, userId, amount, currency, serialNumber, productAmount, productCurrency, productLinks, service, accountIdentifier, subscriptionAmount, subscriptionCurrency, feeAmount, totalAmountToDeduct });
            try {
                const userProfileRef = doc(db, 'artifacts', appId, 'users', userId);
                const requestDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'pending_requests', requestId);

                console.log("Fetching user profile...");
                const userDocSnap = await getDoc(userProfileRef);

                if (!userDocSnap.exists()) {
                    console.error("Error: User profile not found for request:", userId);
                    showMessage('Error: Usuario no encontrado para la solicitud.', 'error');
                    return;
                }
                const userData = userDocSnap.data();
                let userCurrentBalanceUSD = userData.balanceUSD || 0;
                let userCurrentBalanceDOP = userData.balanceDOP || 0;

                console.log("User current balances (before update):", { userCurrentBalanceUSD, userCurrentBalanceDOP });

                let adminId = null;
                console.log("Searching for admin account...");
                const adminUsersCollectionRef = collection(db, 'artifacts', appId, 'users');
                const adminQuery = query(adminUsersCollectionRef, where('email', '==', ADMIN_EMAIL));
                const adminSnapshot = await getDocs(adminQuery);
                if (!adminSnapshot.empty) {
                    adminId = adminSnapshot.docs[0].id;
                    console.log("Admin ID found:", adminId);
                } else {
                    console.warn("Admin account not found. Fees might not be transferred to admin.");
                }

                let transactionType = type;
                let transactionDescription = '';
                let receiptDetails = {
                    title: '',
                    date: new Date().toLocaleString(),
                    type: '',
                    amount: 0,
                    currency: '',
                    feeAmount: 0,
                    feeCurrency: 'USD'
                };
                let amountToRecordInTransaction = amount; // Default to original request amount
                let currencyToRecordInTransaction = currency; // Default to original request currency
                let typeDisplay = ''; // Initialize typeDisplay here

                switch (type) {
                    case 'deposit':
                        let depositAmountInUSD = amount;
                        if (currency === 'DOP') {
                            depositAmountInUSD = amount / USD_TO_DOP_RATE;
                        }
                        userCurrentBalanceUSD += depositAmountInUSD;
                        userCurrentBalanceDOP = userCurrentBalanceUSD * USD_TO_DOP_RATE;
                        transactionDescription = `Depósito con serie ${serialNumber}`;
                        typeDisplay = 'Depósito'; // Set typeDisplay here
                        receiptDetails = {
                            title: 'Recibo de Depósito',
                            type: 'Depósito',
                            amount: amount,
                            currency: currency,
                            description: transactionDescription
                        };
                        console.log("Deposit logic applied. New user USD balance:", userCurrentBalanceUSD);
                        break;
                    case 'withdrawal':
                        let withdrawalAmountInUSD = amount;
                        if (currency === 'DOP') {
                            withdrawalAmountInUSD = amount / USD_TO_DOP_RATE;
                        }
                        const calculatedFeeInUSD = withdrawalAmountInUSD * WITHDRAWAL_FEE_RATE;
                        const totalDeductionFromUserForWithdrawal = withdrawalAmountInUSD + calculatedFeeInUSD;

                        if (userCurrentBalanceUSD < totalDeductionFromUserForWithdrawal) {
                            console.error("Error: Insufficient balance for withdrawal.");
                            showMessage(`Error: Saldo insuficiente ($${userCurrentBalanceUSD.toFixed(2)} USD) para cubrir el retiro de ${amount.toFixed(2)} ${currency} más la tarifa del 4% ($${calculatedFeeInUSD.toFixed(2)} USD).`, 'error');
                            return;
                        }
                        userCurrentBalanceUSD -= totalDeductionFromUserForWithdrawal;
                        userCurrentBalanceDOP = userCurrentBalanceUSD * USD_TO_DOP_RATE;
                        transactionDescription = `Retiro (Tarifa: ${calculatedFeeInUSD.toFixed(2)} USD)`;
                        typeDisplay = 'Retiro'; // Set typeDisplay here
                        receiptDetails = {
                            title: 'Recibo de Retiro',
                            type: 'Retiro',
                            amount: amount,
                            currency: currency,
                            feeAmount: calculatedFeeInUSD,
                            feeCurrency: 'USD',
                            description: transactionDescription
                        };
                        console.log("Withdrawal logic applied. New user USD balance:", userCurrentBalanceUSD);

                        // Transfer fee to admin
                        if (adminId) {
                            console.log("Transferring withdrawal fee to admin:", calculatedFeeInUSD, "USD");
                            const adminProfileRef = doc(db, 'artifacts', appId, 'users', adminId);
                            const adminData = (await getDoc(adminProfileRef)).data();
                            let adminNewBalanceUSD = (adminData.balanceUSD || 0) + calculatedFeeInUSD;
                            await updateDoc(adminProfileRef, { balanceUSD: adminNewBalanceUSD, balanceDOP: adminNewBalanceUSD * USD_TO_DOP_RATE });
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                                payerId: userId,
                                receiverId: adminId,
                                amount: calculatedFeeInUSD,
                                currency: 'USD',
                                timestamp: serverTimestamp(),
                                type: 'withdrawal_fee',
                                status: 'completed',
                                originalRequestId: requestId
                            });
                            console.log("Withdrawal fee transferred to admin and recorded.");
                        }
                        break;
                    case 'online_purchase':
                        console.log("Processing online_purchase. totalAmountToDeduct:", totalAmountToDeduct);
                        if (userCurrentBalanceUSD < totalAmountToDeduct) {
                            console.error("Error: Insufficient balance for online purchase.");
                            showMessage(`Error: Saldo insuficiente ($${userCurrentBalanceUSD.toFixed(2)} USD) para la compra online.`, 'error');
                            return;
                        }
                        userCurrentBalanceUSD -= totalAmountToDeduct;
                        userCurrentBalanceDOP = userCurrentBalanceUSD * USD_TO_DOP_RATE;
                        transactionDescription = `Compra online`;
                        amountToRecordInTransaction = totalAmountToDeduct; // Record total deducted from user
                        currencyToRecordInTransaction = 'USD'; // Always USD for this deduction
                        typeDisplay = 'Compra Online'; // Set typeDisplay here
                        receiptDetails = {
                            title: 'Recibo de Compra Online',
                            type: 'Compra Online',
                            amount: totalAmountToDeduct,
                            currency: 'USD',
                            productAmount: productAmount,
                            productCurrency: productCurrency,
                            feeAmount: feeAmount,
                            feeCurrency: 'USD',
                            productLinks: productLinks,
                            description: transactionDescription
                        };
                        console.log("Online purchase logic applied. New user USD balance:", userCurrentBalanceUSD);

                         // Transfer entire amount (products + fee) to admin
                        if (adminId) {
                            console.log("Transferring total online purchase amount to admin:", totalAmountToDeduct, "USD");
                            const adminProfileRef = doc(db, 'artifacts', appId, 'users', adminId);
                            const adminData = (await getDoc(adminProfileRef)).data();
                            let adminNewBalanceUSD = (adminData.balanceUSD || 0) + totalAmountToDeduct;
                            await updateDoc(adminProfileRef, { balanceUSD: adminNewBalanceUSD, balanceDOP: adminNewBalanceUSD * USD_TO_DOP_RATE });
                            // No separate fee transaction for admin for online_purchase/streaming, as the entire deducted amount goes to admin.
                            console.log("Online purchase amount transferred to admin.");
                        }
                        break;
                    case 'streaming_payment':
                        console.log("Processing streaming_payment. totalAmountToDeduct:", totalAmountToDeduct);
                        if (userCurrentBalanceUSD < totalAmountToDeduct) {
                            console.error("Error: Insufficient balance for streaming payment.");
                            showMessage(`Error: Saldo insuficiente ($${userCurrentBalanceUSD.toFixed(2)} USD) para el pago de streaming.`, 'error');
                            return;
                        }
                        userCurrentBalanceUSD -= totalToDeduct;
                        userCurrentBalanceDOP = userCurrentBalanceUSD * USD_TO_DOP_RATE;
                        transactionDescription = `Pago de ${service}`;
                        amountToRecordInTransaction = totalToDeduct; // Record total deducted from user
                        currencyToRecordInTransaction = 'USD'; // Always USD for this deduction
                        typeDisplay = 'Pago Streaming'; // Set typeDisplay here
                        receiptDetails = {
                            title: 'Recibo de Pago Streaming',
                            type: 'Pago Streaming',
                            amount: totalToDeduct,
                            currency: 'USD',
                            service: service,
                            accountIdentifier: accountIdentifier,
                            subscriptionAmount: subscriptionAmount,
                            subscriptionCurrency: subscriptionCurrency,
                            feeAmount: feeAmount,
                            feeCurrency: 'USD',
                            description: transactionDescription
                        };
                        console.log("Streaming payment logic applied. New user USD balance:", userCurrentBalanceUSD);

                        // Transfer entire amount (subscription + fee) to admin
                        if (adminId) {
                            console.log("Transferring total streaming payment amount to admin:", totalToDeduct, "USD");
                            const adminProfileRef = doc(db, 'artifacts', appId, 'users', adminId);
                            const adminData = (await getDoc(adminProfileRef)).data();
                            let adminNewBalanceUSD = (adminData.balanceUSD || 0) + totalToDeduct;
                            await updateDoc(adminProfileRef, { balanceUSD: adminNewBalanceUSD, balanceDOP: adminNewBalanceUSD * USD_TO_DOP_RATE });
                            console.log("Streaming payment amount transferred to admin.");
                        }
                        break;
                    default:
                        console.error("Error: Unknown request type:", type);
                        showMessage('Tipo de solicitud desconocido.', 'error');
                        typeDisplay = 'Desconocido'; // Fallback for typeDisplay
                        return;
                }

                console.log("Attempting to update user profile...", { balanceUSD: userCurrentBalanceUSD, balanceDOP: userCurrentBalanceDOP, hasPendingDeposit: (type === 'deposit' ? false : userData.hasPendingDeposit) });
                await updateDoc(userProfileRef, {
                    balanceUSD: userCurrentBalanceUSD,
                    balanceDOP: userCurrentBalanceDOP,
                    ...(type === 'deposit' && { hasPendingDeposit: false })
                });
                console.log("User profile updated successfully.");

                console.log("Attempting to update request status to completed...");
                await updateDoc(requestDocRef, {
                    status: 'completed',
                    confirmedAt: serverTimestamp()
                });
                console.log("Request status updated successfully.");

                console.log("Attempting to add transaction record...", { userId, type: transactionType, amount: amountToRecordInTransaction, currency: currencyToRecordInTransaction });
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                    userId: userId,
                    type: transactionType,
                    amount: amountToRecordInTransaction,
                    currency: currencyToRecordInTransaction,
                    timestamp: serverTimestamp(),
                    status: 'completed',
                    description: transactionDescription,
                    // Store additional details for specific types
                    ...(type === 'withdrawal' && { feeAmount: calculatedFeeInUSD, feeCurrency: 'USD', adminReceiverId: adminId }),
                    ...(type === 'online_purchase' && { productAmount, productCurrency, productLinks, feeAmount, feeCurrency: 'USD', totalAmountDeducted: totalAmountToDeduct, adminReceiverId: adminId }),
                    ...(type === 'streaming_payment' && { service, accountIdentifier, subscriptionAmount, subscriptionCurrency, feeAmount, feeCurrency: 'USD', totalAmountDeducted: totalToDeduct, adminReceiverId: adminId })
                });
                console.log("Transaction recorded successfully.");

                showMessage(`Solicitud #${requestId} (${typeDisplay}) confirmada exitosamente.`, 'success');

                if (currentUserId === userId) {
                    console.log("Showing receipt to current user.");
                    showReceipt(receiptDetails);
                }

            } catch (error) {
                console.error(`GLOBAL CATCH: Error confirmando solicitud ${type} #${requestId}:`, error);
                showMessage(`Error al confirmar la solicitud ${type}. Por favor, inténtalo de nuevo. Detalle: ${error.message}`, 'error');
            }
        }

        /**
         * Rejects a pending request.
         */
        async function rejectRequest(requestId, type, userId) {
            try {
                const requestDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'pending_requests', requestId);

                await updateDoc(requestDocRef, {
                    status: 'rejected',
                    rejectedAt: serverTimestamp()
                });

                // For deposits, reset the hasPendingDeposit flag so user can request again
                if (type === 'deposit') {
                    const userProfileRef = doc(db, 'artifacts', appId, 'users', userId);
                    await updateDoc(userProfileRef, {
                        hasPendingDeposit: false
                    });
                }

                showMessage(`Solicitud #${requestId} (${type}) rechazada exitosamente.`, 'info');

            } catch (error) {
                console.error(`Error rechazando solicitud ${type} #${requestId}:`, error);
                showMessage(`Error al rechazar la solicitud ${type}. Por favor, inténtalo de nuevo. Detalle: ${error.message}`, 'error');
            }
        }


        /**
         * Loads and displays the current user's transaction history.
         */
        async function loadUserHistory() {
            userHistoryTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">Cargando historial...</td></tr>';
            const transactionsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');

            const q = query(transactionsCollectionRef,
                where('status', '==', 'completed')
            );

            onSnapshot(q, async (snapshot) => {
                userHistoryTableBody.innerHTML = '';
                const userTransactions = [];

                for (const docEntry of snapshot.docs) {
                    const transaction = { id: docEntry.id, ...docEntry.data() };

                    // Filter for current user's completed transactions
                    if ((transaction.type === 'deposit' || transaction.type === 'withdrawal' || transaction.type === 'online_purchase' || transaction.type === 'streaming_payment') && transaction.userId === currentUserId) {
                        userTransactions.push(transaction);
                    } else if (transaction.type === 'transfer' && (transaction.senderId === currentUserId || transaction.recipientId === currentUserId)) {
                        userTransactions.push(transaction);
                    }
                }

                if (userTransactions.length === 0) {
                    userHistoryTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">No hay movimientos en tu historial.</td></tr>';
                    return;
                }

                // Sort transactions by timestamp descending (newest first)
                userTransactions.sort((a, b) => {
                    const timestampA = a.timestamp && typeof a.timestamp.seconds !== 'undefined' ? a.timestamp.seconds : 0;
                    const timestampB = b.timestamp && typeof b.timestamp.seconds !== 'undefined' ? b.timestamp.seconds : 0;
                    return timestampB - timestampA;
                });

                for (const transaction of userTransactions) {
                    const date = (transaction.timestamp && typeof transaction.timestamp.seconds !== 'undefined')
                        ? new Date(transaction.timestamp.seconds * 1000).toLocaleString()
                        : 'Fecha no disponible';

                    let typeDisplay = '';
                    let detailsDisplay = '';
                    let amountDisplay = '';

                    switch (transaction.type) {
                        case 'deposit':
                            typeDisplay = 'Depósito';
                            detailsDisplay = `Serie: ${transaction.description.split('Serie: ')[1] || 'N/A'}`;
                            amountDisplay = `+${transaction.amount.toFixed(2)} ${transaction.currency}`;
                            break;
                        case 'withdrawal':
                            typeDisplay = 'Retiro';
                            detailsDisplay = `Tarifa: ${transaction.feeAmount ? `$${transaction.feeAmount.toFixed(2)} USD` : '0.00'}`;
                            amountDisplay = `-${transaction.amount.toFixed(2)} ${transaction.currency}`;
                            break;
                        case 'transfer':
                            if (transaction.senderId === currentUserId) {
                                typeDisplay = 'Transferencia Enviada';
                                const recipientDisplayName = await getUserDisplayName(transaction.recipientId);
                                detailsDisplay = `A: ${recipientDisplayName}`;
                                amountDisplay = `-${transaction.amount.toFixed(2)} ${transaction.currency}`;
                            } else if (transaction.recipientId === currentUserId) {
                                typeDisplay = 'Transferencia Recibida';
                                const senderDisplayName = await getUserDisplayName(transaction.senderId);
                                detailsDisplay = `De: ${senderDisplayName}`;
                                amountDisplay = `+${transaction.amount.toFixed(2)} ${transaction.currency}`;
                            }
                            break;
                        case 'online_purchase':
                            typeDisplay = 'Compra Online';
                            detailsDisplay = `Total productos: ${transaction.productAmount.toFixed(2)} ${transaction.productCurrency}, Tarifa: ${transaction.feeAmount.toFixed(2)} ${transaction.feeCurrency}`;
                            amountDisplay = `-${transaction.totalAmountDeducted.toFixed(2)} ${transaction.currency}`; // This is the total deducted
                            break;
                        case 'streaming_payment':
                            typeDisplay = 'Pago Streaming';
                            detailsDisplay = `Servicio: ${transaction.service}, Cuenta: ${transaction.accountIdentifier}, Tarifa: ${transaction.feeAmount.toFixed(2)} ${transaction.feeCurrency}`;
                            amountDisplay = `-${transaction.totalAmountDeducted.toFixed(2)} ${transaction.currency}`; // This is the total deducted
                            break;
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${typeDisplay}</td>
                        <td>${detailsDisplay}</td>
                        <td>${amountDisplay}</td>
                        <td>${transaction.currency}</td>
                    `;
                    userHistoryTableBody.appendChild(row);
                }
            }, (error) => {
                console.error("Error loading user history:", error);
                userHistoryTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-red-500 py-4">Error al cargar tu historial.</td></tr>`;
            });
        }


        /**
         * Loads and displays the full transaction history for all users in the admin modal.
         */
        async function loadAdminFullHistory() {
            console.log("Admin: loadAdminFullHistory() called.");
            adminFullHistoryTableBodyModal.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-4">Cargando historial completo...</td></tr>';
            const transactionsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
            const q = query(transactionsCollectionRef, where('status', '==', 'completed'));

            onSnapshot(q, async (snapshot) => {
                console.log("Admin: onSnapshot for admin full history triggered.");
                console.log("Admin: Snapshot size for full history:", snapshot.size);

                adminFullHistoryTableBodyModal.innerHTML = '';
                if (snapshot.empty) {
                    adminFullHistoryTableBodyModal.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-4">No hay transacciones en el historial.</td></tr>';
                    console.log("Admin: No transactions found for admin history.");
                    return;
                }

                const allTransactions = [];
                for (const docEntry of snapshot.docs) {
                    allTransactions.push({ id: docEntry.id, ...docEntry.data() });
                }

                // Sort transactions by timestamp descending (newest first)
                allTransactions.sort((a, b) => {
                    const timestampA = a.timestamp && typeof a.timestamp.seconds !== 'undefined' ? a.timestamp.seconds : 0;
                    const timestampB = b.timestamp && typeof b.timestamp.seconds !== 'undefined' ? b.timestamp.seconds : 0;
                    return timestampB - timestampA;
                });

                for (const transaction of allTransactions) {
                    const date = (transaction.timestamp && typeof transaction.timestamp.seconds !== 'undefined')
                        ? new Date(transaction.timestamp.seconds * 1000).toLocaleString()
                        : 'Fecha no disponible';

                    let typeDisplay = transaction.type;
                    let usersInvolved = '';
                    let details = '';
                    let amountValue = transaction.amount;
                    let currencyValue = transaction.currency;

                    switch (transaction.type) {
                        case 'deposit':
                            typeDisplay = 'Depósito';
                            usersInvolved = await getUserDisplayName(transaction.userId);
                            details = `Serie: ${transaction.description.split('Serie: ')[1] || 'N/A'}`;
                            break;
                        case 'withdrawal':
                            typeDisplay = 'Retiro';
                            usersInvolved = await getUserDisplayName(transaction.userId);
                            details = `Tarifa: $${transaction.feeAmount ? transaction.feeAmount.toFixed(2) : '0.00'} USD`;
                            break;
                        case 'transfer':
                            typeDisplay = 'Transferencia';
                            const senderName = await getUserDisplayName(transaction.senderId);
                            const recipientName = await getUserDisplayName(transaction.recipientId);
                            usersInvolved = `${senderName} (envía) -> ${recipientName} (recibe)`;
                            details = `Descripción: ${transaction.description || 'N/A'}`;
                            break;
                        case 'withdrawal_fee':
                            typeDisplay = 'Tarifa de Retiro Cobrada';
                            const feePayer = await getUserDisplayName(transaction.payerId);
                            const feeReceiver = await getUserDisplayName(transaction.receiverId);
                            usersInvolved = `${feePayer} (paga) -> ${feeReceiver} (recibe)`;
                            details = `ID Solicitud Original: ${transaction.originalRequestId || 'N/A'}`;
                            amountValue = transaction.amount; // This is the fee amount
                            currencyValue = 'USD';
                            break;
                        case 'online_purchase':
                            typeDisplay = 'Compra Online';
                            usersInvolved = await getUserDisplayName(transaction.userId);
                            details = `Links: ${transaction.productLinks.substring(0, 50)}... Total prod: ${transaction.productAmount.toFixed(2)} ${transaction.productCurrency}, Tarifa: ${transaction.feeAmount.toFixed(2)} ${transaction.feeCurrency}`;
                            amountValue = transaction.totalAmountDeducted; // Show total deducted from user
                            currencyValue = 'USD';
                            break;
                        case 'streaming_payment':
                            typeDisplay = 'Pago Streaming';
                            usersInvolved = await getUserDisplayName(transaction.userId);
                            details = `Servicio: ${transaction.service}, Cuenta: ${transaction.accountIdentifier}, Tarifa: ${transaction.feeAmount.toFixed(2)} ${transaction.feeCurrency}`;
                            amountValue = transaction.totalAmountDeducted; // Show total deducted from user
                            currencyValue = 'USD';
                            break;
                        default:
                            usersInvolved = transaction.userId || 'N/A'; // Fallback
                            details = 'N/A';
                    }


                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${typeDisplay}</td>
                        <td>${usersInvolved}</td>
                        <td>${amountValue.toFixed(2)}</td>
                        <td>${currencyValue}</td>
                        <td>${transaction.status}</td>
                        <td>${details}</td>
                    `;
                    adminFullHistoryTableBodyModal.appendChild(row); // Append to modal's tbody
                }
                console.log(`Admin: Loaded ${snapshot.docs.length} total transactions for admin history.`);
            }, (error) => {
                console.error("Admin: Error loading admin full history:", error);
                adminFullHistoryTableBodyModal.innerHTML = `<tr><td colspan="7" class="text-center text-red-500 py-4">Error al cargar el historial completo.</td></tr>`;
            });
        }

        /**
         * Loads and displays the current user's pending deposits and withdrawals, and other pending requests.
         */
        async function loadUserPendingRequests() {
            userPendingRequestsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-4">Cargando solicitudes...</td></tr>';

            const pendingRequestsRef = collection(db, 'artifacts', appId, 'public', 'data', 'pending_requests');
            const userPendingQuery = query(pendingRequestsRef, where('userId', '==', currentUserId), where('status', '==', 'pending'));

            onSnapshot(userPendingQuery, async (snapshot) => {
                userPendingRequestsTableBody.innerHTML = ''; // Clear table for new data
                const allPendingRequests = [];

                snapshot.forEach(docEntry => {
                    const data = docEntry.data();
                    let typeDisplay = '';
                    let detailDisplay = '';
                    let amountToDisplay = data.amount;
                    let currencyToDisplay = data.currency;

                    switch (data.type) {
                        case 'deposit':
                            typeDisplay = 'Depósito';
                            detailDisplay = `Serie: ${data.serialNumber}`;
                            break;
                        case 'withdrawal':
                            typeDisplay = 'Retiro';
                            detailDisplay = `Tarifa est. (4%): $${data.estimatedFee ? data.estimatedFee.toFixed(2) : '0.00'} USD`;
                            break;
                        case 'online_purchase':
                            typeDisplay = 'Compra Online';
                            amountToDisplay = data.totalAmountToDeduct; // Show total that will be deducted
                            currencyToDisplay = 'USD';
                            detailDisplay = `Total productos: ${data.productAmount.toFixed(2)} ${data.productCurrency}, Tarifa: ${data.feeAmount.toFixed(2)} USD`;
                            break;
                        case 'streaming_payment':
                            typeDisplay = 'Pago Streaming';
                            amountToDisplay = data.totalAmountToDeduct; // Show total that will be deducted
                            currencyToDisplay = 'USD';
                            detailDisplay = `Servicio: ${data.service}, Cuenta: ${data.accountIdentifier}, Tarifa: ${data.feeAmount.toFixed(2)} USD`;
                            break;
                        default:
                            typeDisplay = 'Desconocido';
                            detailDisplay = 'N/A';
                    }

                    allPendingRequests.push({
                        id: docEntry.id,
                        type: typeDisplay,
                        amount: amountToDisplay,
                        currency: currencyToDisplay,
                        status: data.status,
                        timestamp: data.timestamp,
                        detail: detailDisplay
                    });
                });

                if (allPendingRequests.length === 0) {
                    userPendingRequestsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-4">No tienes solicitudes pendientes.</td></tr>';
                    return;
                }

                // Sort by timestamp descending
                allPendingRequests.sort((a, b) => {
                    const timestampA = a.timestamp && typeof a.timestamp.seconds !== 'undefined' ? a.timestamp.seconds : 0;
                    const timestampB = b.timestamp && typeof b.timestamp.seconds !== 'undefined' ? b.timestamp.seconds : 0;
                    return timestampB - timestampA;
                });

                for (const request of allPendingRequests) {
                    const date = (request.timestamp && typeof request.timestamp.seconds !== 'undefined')
                        ? new Date(request.timestamp.seconds * 1000).toLocaleString()
                        : 'Fecha no disponible';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${request.type}</td>
                        <td>${request.amount.toFixed(2)}</td>
                        <td>${request.currency}</td>
                        <td>${request.status === 'pending' ? 'Pendiente' : request.status}</td>
                        <td>${request.detail}</td>
                    `;
                    userPendingRequestsTableBody.appendChild(row);
                }
            }, (error) => {
                console.error("Error loading user pending requests:", error);
                userPendingRequestsTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 py-4">Error al cargar solicitudes pendientes.</td></tr>`;
            });
        }


        // --- Event Listeners ---
        window.onload = () => {
             // onAuthStateChanged will handle the user's login state automatically
        };


        loginTab.addEventListener('click', () => toggleTabs('login'));
        registerTab.addEventListener('click', () => toggleTabs('register'));
        closeMessage.addEventListener('click', hideMessage);

        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        toggleCurrencyBtn.addEventListener('click', toggleCurrencyDisplay);

        // Rules Consent buttons
        acceptRulesBtn.addEventListener('click', () => {
            rulesConsentModal.classList.add('hidden');
            // Proceed with registration using stored data
            performRegistration(tempRegisterData.name, tempRegisterData.surname, tempRegisterData.age, tempRegisterData.password);
        });

        rejectRulesBtn.addEventListener('click', () => {
            rulesConsentModal.classList.add('hidden');
            showMessage('Debes aceptar las reglas para registrarte en el Banco Juvenil.', 'error');
            registerForm.reset(); // Clear the form if rules are rejected
            tempRegisterData = {}; // Clear temporary data
        });

        // User History Modal buttons
        viewHistoryBtn.addEventListener('click', () => {
            userHistoryModal.classList.remove('hidden');
            loadUserHistory(); // Load user-specific history
        });
        closeUserHistoryModalBtn.addEventListener('click', () => {
            closeModal(userHistoryModal);
        });

        // Admin Full History Modal buttons
        adminFullHistoryBtn.addEventListener('click', () => {
            adminFullHistoryModal.classList.remove('hidden');
            loadAdminFullHistory(); // Load full admin history
        });
        closeAdminFullHistoryModalBtn.addEventListener('click', () => {
            closeModal(adminFullHistoryModal);
        });

        // Admin Pending Requests Modal button (Unified)
        viewAdminPendingRequestsBtn.addEventListener('click', () => {
            adminPendingRequestsModal.classList.remove('hidden');
            loadAdminPendingRequests();
        });
        closeAdminPendingRequestsModalBtn.addEventListener('click', () => {
            closeModal(adminPendingRequestsModal);
        });

        // FAQ Modal buttons
        viewFAQBtn.addEventListener('click', () => {
            faqModal.classList.remove('hidden');
        });
        closeFAQModalBtn.addEventListener('click', () => {
            closeModal(faqModal);
        });

        // Online Shopping Buttons
        onlineShoppingBtn.addEventListener('click', () => {
            onlineShoppingModal.classList.remove('hidden');
            onlineShoppingForm.reset(); // Reset form when opened
            updateOnlineShoppingCalculation(); // Initial calculation display
        });
        cancelOnlineShopping.addEventListener('click', () => {
            closeModal(onlineShoppingModal);
        });

        // Streaming Payment Buttons
        streamingPaymentBtn.addEventListener('click', () => {
            streamingPaymentModal.classList.remove('hidden');
            streamingPaymentForm.reset(); // Reset form when opened
            updateStreamingPaymentCalculation(); // Initial calculation display
        });
        cancelStreamingPayment.addEventListener('click', () => {
            closeModal(streamingPaymentModal);
        });

        // User Pending Requests Button
        viewUserPendingRequestsBtn.addEventListener('click', () => {
            userPendingRequestsModal.classList.remove('hidden');
            loadUserPendingRequests();
        });
        closeUserPendingRequestsModalBtn.addEventListener('click', () => {
            closeModal(userPendingRequestsModal);
        });

        // Receipt Modal Button
        closeReceiptModalBtn.addEventListener('click', () => {
            closeModal(receiptModal);
        });

    </script>
</body>
</html>
